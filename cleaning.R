library(tidytext)
library(SemNetCleaner)
library(tm)
library(english)
library(xfun)
library(tidyr)
library(dplyr)
library(stringdist)
library(tidyverse)
library(stringr)
library(extrafont)
library(dendextend)
library(RColorBrewer)
library(ggplot2)
library(tidyr)
library(tibble)
library(hrbrthemes)
library(dplyr)
library(wesanderson)

###############################################################################
## ++++++++++++++++++++++++ Upload Indicators ++++++++++++++++++++++++++++++###
###############################################################################
df.indicators = read.csv("D:/Projects/Project_Indicators/Data/Spreadsheets/Indicators/Indicators_Processed_v5.csv")

source("D:/Projects/Project_Mother/Scripts/kings.R")
source("D:/Projects/Project_Mother/Scripts/map.R")
###############################################################################
## ++++++++++++++++++++++ Clean up  Indicators ++++++++++++++++++++++++++++++###
###############################################################################

# deleting punctuations
df.indicators$Indicator<-gsub("[[:punct:][:blank:]]+", " ", df.indicators$Indicator)
# deleting trailing space
df.indicators$Indicator<-gsub("\\n"," ", df.indicators$Indicator)

text= as.character(as.factor(df.indicators$Indicator))
text = tolower(text)
text <- gsub("\n", " ", text)
text <- gsub("^\\s+", "", text)
text <- gsub("\\s+$", "", text)
text <- gsub("[ |\t]+", " ", text)
text <- gsub("[ |\t]+", " ", text)

#text <- gsub('[[:punct:] ]+',"",text)

df.indicators$Indicator_rev <- text
head(df.indicators$Indicator_rev, 10)

# Create dataframe of the stop words
stop_words = read.csv("D:/Projects/Project_Indicators/Data/Spreadsheets/Look-Up Tables/stop_words.csv")

###############################################################################
## ++++++++++++++++++++++ Subset by D and SD  ++++++++++++++++++++++++++++++###
###############################################################################
data.frame.sub = df.indicators %>% dplyr::filter(Sub.Domain == "A")

# Convert to tidy format
tidy_text <- data.frame.sub %>%
  select(Citation, Indicator, Indicator_rev) %>%
  # Tokenize the word from the tweets
  unnest_tokens(input = Indicator_rev, output = word) %>%
  # Remove stop words
  anti_join(stop_words, by="word") %>% ungroup() %>%
  reshape2::melt(id = c("Citation", "Indicator")) 

tidy_text_rev = tidy_text %>% group_by(Citation, Indicator)%>%
  dplyr::summarise(Indicator_rev = paste(value, collapse = " "))

data.frame.sub.clusters = map_dfr(tidy_text_rev$Indicator_rev, ~ {
  i <- which(stringdist(., tidy_text_rev$Indicator_rev, "jw") < 0.40)
  tibble(index = i, Indicator = tidy_text_rev$Indicator[i],Indicator_rev = tidy_text_rev$Indicator_rev[i])
}, .id = "group") %>%
  distinct(index, .keep_all = T) %>% 
  mutate(group = as.integer(group))

num.clus = length(unique(data.frame.sub.clusters$group))

## Remove duplicates
data.frame.sub.clusters = separate_rows(data.frame.sub.clusters, Indicator_rev) %>%
  group_by(Indicator) %>%
  summarise(Indicators_rev_cleaned = paste(rle(Indicator_rev)$values, collapse=" "))

## Look at clusters
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicators_rev_cleaned))
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw")
# rownames(distancemodels) <- uniquemodels
# colnames(distancemodels) <- uniquemodels

df <- scale(mtcars)
row_dend = hclust(dist(df)) # row clustering
col_dend = hclust(dist(t(df))) # column clustering
Heatmap(distancemodels, name = "mtcars", 
        row_names_gp = gpar(fontsize = 6.5),
        cluster_rows = 13,
        cluster_columns = 13)

##heat maps
heatmap(distancemodels, col =  col)


## test code for ggplot2
dm.melt = distancemodels %>% reshape2::melt()
names(dm.melt) = c("X", "Y", "Z")
length(unique(dm.melt$Z))
pal <- wes_palette("Zissou1", 3000, type = "continuous")

ggplot(dm.melt) + 
  geom_tile(aes(as.character(X), as.character(Y), fill= Z)) +
  scale_fill_gradientn(colours = pal) +ylab("")+xlab("")+
  ggtitle("Water Source Sub-Domain Indicators")+
  theme_minimal(base_size = 18)


## order and add count columns
data.frame.sub.clusters$count = rep(1)

## group to see individual indicators
cleaned_text= as.character(as.factor(data.frame.sub.clusters$Indicators_rev_cleaned))
cleaned_text <- paste(cleaned_text, collapse = " ")
text_df <- data_frame(Text = cleaned_text) 
text_words <- text_df %>% 
  unnest_tokens(output = word, input = Text) 
text_wordcounts <- text_words  %>% count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >1,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("s"),]

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  mutate(rank = nrow(data.wordcount) - row_number()+1)

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  dplyr::mutate(percent = (n/sum(n))*100)

data.wordcount$code_rev = ifelse(data.wordcount$percent < 7, "general", data.wordcount$word)

data.wordcount.sum = data.wordcount %>% group_by(code_rev) %>%
  dplyr::summarize(percent.mod = sum(percent),
                   indicator.num = round((percent.mod/100) * nrow(data.frame.sub), digits = 0))

write.csv(data.wordcount.sum, "D:/Projects/Project_Indicators/Data/Spreadsheets/ClusterResults/Indicators_C.csv")

## Plot
plot1K = ggplot(data = data.wordcount) +
  geom_segment(aes(x=rank, xend=rank, y=0, yend=n), color="grey50") +
  geom_point(aes(x=rank, y=n),fill="#9e9ac8", shape = 21, 
             color = "black", size=5, alpha = 0.7 ) +
  coord_flip()+scale_y_continuous(limits = c(0,30))+
    scale_x_continuous(
      breaks = data.wordcount$rank, # specify tick breaks using rank column
      labels = data.wordcount$word # specify tick labels using x column
    )+theme_bw(base_size = 28)+
    xlab("")+ylab("")


###############################################################################
## ++++++++++++++++++++++ Water Supply Plot   ++++++++++++++++++++++++++++++###
###############################################################################
windows()
ws.plot = cowplot::ggdraw() +
  cowplot::draw_plot(plot1A,x=0,  y = 0.35, width =0.45, height= 0.63) + 
  cowplot::draw_plot(plot1B,x=0.5, y=0.35, width =0.45, height= 0.63) + 
  cowplot::draw_plot(plot1C,x=0+0.018,y=0-0.03, width =0.43, height= 0.40)+
  cowplot::draw_plot(plot1D,x=0.5+0.007, y=0-0.03, width =0.445, height= 0.40)+
  cowplot::draw_text("Water Source", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.3, y = 0.99)+
  cowplot::draw_text("Water Quality", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x=0.75, y = 0.99)+
  cowplot::draw_text("Water Infrastructure & Distribution", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.3, y = 0.37)+
  cowplot::draw_text("Physical Environment", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.75, y = 0.37)+
  cowplot::draw_text("A", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.1, y = 0.99)+
  cowplot::draw_text("B", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x=0.6, y = 0.99)+
  cowplot::draw_text("C", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.1, y = 0.37)+
  cowplot::draw_text("D", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.6, y = 0.37)

ggsave(plot = ws.plot,"D:/Projects/Project_Indicators/Documents/Figures/ws_plot.jpg", 
       width=21, height=17, dpi=300)


###############################################################################
## ++++++++++++++++++++++ Water Demand Plot   ++++++++++++++++++++++++++++++###
###############################################################################

wd.plot = cowplot::ggdraw() +
  cowplot::draw_plot(plot1H,x=0,  y = 0.35, width =0.45, height= 0.63) + 
  cowplot::draw_plot(plot1G,x=0.5, y=0.35, width =0.45, height= 0.63) + 
  cowplot::draw_plot(plot1F,x=0+0.018,y=0-0.03, width =0.43, height= 0.40)+
  cowplot::draw_plot(plot1I,x=0.5+0.007, y=0-0.03, width =0.445, height= 0.40)+
  cowplot::draw_text("Urban & Municipal", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.3, y = 0.99)+
  cowplot::draw_text("Agricultural", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x=0.75, y = 0.99)+
  cowplot::draw_text("Cultural & Environmental", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.3, y = 0.37)+
  cowplot::draw_text("General", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.75, y = 0.37)+
  cowplot::draw_text("A", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.1, y = 0.99)+
  cowplot::draw_text("B", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x=0.6, y = 0.99)+
  cowplot::draw_text("C", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.1, y = 0.37)+
  cowplot::draw_text("D", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.6, y = 0.37)

ggsave(plot = wd.plot,"D:/Projects/Project_Indicators/Documents/Figures/wd_plot.jpg", 
       width=21, height=17, dpi=300)  


###############################################################################
## ++++++++++++++++++++++ Water Demand Plot   ++++++++++++++++++++++++++++++###
###############################################################################

sv.plot = cowplot::ggdraw() +
  cowplot::draw_plot(plot1J,x=0,  y = 0.35, width =0.45, height= 0.63) + 
  cowplot::draw_plot(plot1K,x=0.5, y=0.13, width =0.45, height= 0.85) + 
  cowplot::draw_plot(plot1L,x=0+0.018,y=0-0.03, width =0.43, height= 0.40)+
  cowplot::draw_text("Institutions & Management", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.3, y = 0.99)+
  cowplot::draw_text("Socio-Cultural", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x=0.75, y = 0.99)+
  cowplot::draw_text("Economic", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.3, y = 0.37)+
  cowplot::draw_text("A", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.1, y = 0.99)+
  cowplot::draw_text("B", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x=0.6, y = 0.99)+
  cowplot::draw_text("C", 
                     size = 26, angle = 0,
                     family = "Helvetica", fontface = "bold", x= 0.1, y = 0.37)

ggsave(plot = sv.plot,"D:/Projects/Project_Indicators/Documents/Figures/sv_plot.jpg", 
       width=21, height=17, dpi=300)  







ggsave(plot = plot1A,"D:/Projects/Project_Indicators/Documents/Figures/Plot_1A.jpg", 
       width=8, height=10, dpi=300)

## read in lookup table
lu = read.csv("D:/Projects/Project_Indicators/Data/Spreadsheets/Look-Up Tables/LU_1A.csv")

## Create a dataframe for analysis
data.frame.final = left_join(data.frame.sub.clusters, tidy_text_rev, by =c("Indicator"))
data.frame.final = data.frame.final %>% left_join(lu, by = c("group"))

write.csv(data.frame.final,"D:/Projects/Project_Indicators/Data/Spreadsheets/ClusterResults/data.frame.final_1F.csv")

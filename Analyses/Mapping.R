library(ggplot2)
library(tidyr)
library(viridis)
library(tidyverse)
library(reshape2)
library(cowplot)
library(dplyr)
library(randomcoloR)
library(ggpubr)
library(RColorBrewer)
library(extrafont)
library(webr)
library(networkD)
library(ggradar)
library(fmsb)
library(scales)
library(moonBook)
library(randomcoloR)
library(data.table)

source("D:/Projects/Project_Mother/Scripts/kings.R")
source("D:/Projects/Project_Mother/Scripts/map.R")
palette <- distinctColorPalette(n)
setseed(1999)
n <- 60
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
## Now read in in your sampled data
dataframe = read.csv("D:/Projects/Project_Indicators/Data/Spreadsheets/Indicators/Indicators_processed_v5.csv")

###############################################################################
## +++++++++++++++++++++++++++++ Lookup Table ++++++++++++++++++++++++++++++###
###############################################################################
## Domain conversion based on codebook
dataframe$Domain = ifelse(dataframe$Code.Number == "1", "Factors Influencing Water Supply",
                          ifelse(dataframe$Code.Number == "2", "Factors Influencing Water Demand",
                                 "Factors Influencing the Social Value of Water"))

## Sub-Domain conversion based on codebook
dataframe$Sub_Domain = ifelse(dataframe$Sub.Domain == "A", "Water Source", 
                              ifelse(dataframe$Sub.Domain == "B", "Water Quality", 
                                     ifelse(dataframe$Sub.Domain == "C", "Water Infrastructure & Distribution",
                                            ifelse(dataframe$Sub.Domain == "D", "Physical Environment",
                                                   ifelse(dataframe$Sub.Domain == "E", "Industrial Water & Land Use",
                                                          ifelse(dataframe$Sub.Domain == "F", "Urban & Municipal Water & Land Use",
                                                                 ifelse(dataframe$Sub.Domain == "G", "Agricultural Land & Water Use",
                                                                        ifelse(dataframe$Sub.Domain == "H", "Cultural & Environemntal Land & Water Use",
                                                                               ifelse(dataframe$Sub.Domain == "I", "General Land & Water Use",
                                                                                      ifelse(dataframe$Sub.Domain == "J", "Institutions & Management", 
                                                                                             ifelse(dataframe$Sub.Domain == "K", "Socio-Cultural", 
                                                                                                    ifelse(dataframe$Sub.Domain == "L","Economic", ""))))))))))))

###############################################################################
## +++++++++++++++++++++++++++++ Summary Info ++++++++++++++++++++++++++++++###
###############################################################################
## Now join them together
df_indicators = dataframe %>% group_by(Domain) %>%
  dplyr::summarise(number = sum(Count))

df_indicators.study = dataframe %>% group_by(Domain, Citation) %>%
  dplyr::summarise(number = sum(Count))

# df_indicators.study$number.rescale = rescale(df_indicators.study$number, to = c(0,1))

indicators.spread = df_indicators.study %>% 
  tidyr::spread(key = Domain, value = number)

indicators.spread[is.na(indicators.spread)] <- 0

coord_radar <- function (theta = "x", start = 0, direction = 1) {
  theta <- match.arg(theta, c("x", "y"))
  r <- if (theta == "x") "y" else "x"
  ggproto("CordRadar", CoordPolar, theta = theta, r = r, start = start, 
          direction = sign(direction),
          is_linear = function(coord) TRUE)
}


toplot <- indicators.spread %>% melt(id="Citation")

toplot <- toplot %>%
  mutate(Domain =  plyr::revalue(variable,
                                c(# Dimensions
                                  "Factors Influencing Water Supply" = "WS",
                                  # Water
                                  "Factors Influencing Water Demand" = "WD",
                                  #Infrastructure
                                  #
                                  "Factors Influencing the Social Value of Water" = "SV")))

###############################################################################
## ++++++++++++++++++++++++++ Study Comparison +++++++++++++++++++++++++++++###
###############################################################################
colourCount = length(unique(toplot$Citation))
getPalette = colorRampPalette(brewer.pal(9, "Set1"))

plot <- ggplot(toplot, aes(x=Domain, y=value, group=Citation), alpha = 0.5) +
  geom_polygon(color = "#3B9AB2", fill ="#3B9AB2", alpha = 0.5, size =1) +
  theme_bw(base_size = 24)+
  coord_radar(start = 4.1)+
  scale_color_manual("",values = getPalette(colourCount))+
  scale_fill_manual("",values = getPalette(colourCount))+
  facet_wrap(Citation ~ ., labeller = label_wrap_gen(width=14), nrow =3) +
  ylab("")+xlab("")+
  scale_y_continuous(limits=c(0,27), expand=c(0,0)) + 
  guides(color = guide_legend(ncol=2)) +
  guides(colour=guide_legend(ncol=1, byrow=TRUE), shape=guide_legend(nrow=1, byrow=TRUE)) +
  theme(axis.title = element_blank(),
        plot.title = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "none")+
  theme(axis.text.x = element_text(colour="black", size=20), 
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        panel.border = element_blank()) #+
  #   annotate("text", x = 0, y=0, label = c("0"), size=6)+
  #   annotate("text", x = 0, y=10, label = c("10"), size=6)+
  #   annotate("text", x = 0, y=20, label = c("20"), size=6)+
  # annotate("text", x = 0, y=Inf, label = c("30"), size=6)

# plot <- ggplot(toplot, aes(x=Dimension, y=value, group=Citation), alpha = 0.5) +
#   geom_polygon(aes(color = Citation, fill = Citation),alpha = 0.8, size =1) +
#   geom_line(aes(color = Citation), size = 1) +
#   theme_minimal(base_size = 24)+
#   coord_radar(start = 3.7)+
#   scale_color_manual("",values = getPalette(colourCount))+
#   scale_fill_manual("",values = getPalette(colourCount))+
#   geom_line(aes(group = Citation, color = Citation), size = 1) +
#   facet_wrap(Citation ~ ., labeller = label_wrap_gen(width=10)) +
#   ylab("")+xlab("")+
#   scale_y_continuous(limits=c(0,27), expand=c(0,0)) + 
#   guides(color = guide_legend(ncol=2)) +
#   guides(colour=guide_legend(ncol=1, byrow=TRUE), shape=guide_legend(nrow=1, byrow=TRUE)) +
#   theme(axis.title = element_blank(),
#         plot.title = element_blank(),
#         axis.ticks.x = element_blank(),
#         # The new stuff
#         strip.text.x = element_blank())+
#   theme(axis.text.x = element_text(colour="black", size=18), 
#         axis.ticks.y = element_blank(),
#         axis.text.y = element_blank(),
#         panel.border = element_blank()) +
#   annotate("text", x = 0, y=0, label = c("0"), size=6)+
#   annotate("text", x = 0, y=10, label = c("10"), size=6)+
#   annotate("text", x = 0, y=20, label = c("20"), size=6)+
#   annotate("text", x = 0, y=Inf, label = c("30"), size=6)

ggsave(plot = plot,"D:/Projects/Project_Indicators/Documents/Figures/plot.png", width=15, height=10, dpi=300)

###############################################################################
## +++++++++++++++++++++++++++++ Water Supply ++++++++++++++++++++++++++++++###
###############################################################################
## Read in the indicator information from the text mining
indicators_analyzed = read.csv("D:/Projects/Project_Indicators/Data/Spreadsheets/ClusterResults/Indicators_full.csv") %>%
  dplyr::select("code_rev", "percent.mod", "indicator.num", "Sub_Domain")

## Now join the dataframe so you have a composite
indicator_sum = dataframe %>% group_by(Domain, Sub_Domain)  %>%
  dplyr::summarise(number = sum(Count)) 
indicator_sum = indicator_sum[indicator_sum$Sub_Domain != "",]

## Join the analyzed indicators and the main dataframe
indicator_sum = left_join(indicator_sum, indicators_analyzed, by = c("Sub_Domain")) %>%
  dplyr::select("Domain", "Sub_Domain", "code_rev", "indicator.num") %>%ungroup()
names(indicator_sum) = c("Domain", "Sub_Domain", "Indicator", "Count")

data.ws = indicator_sum %>% dplyr::filter(Domain == "Factors Influencing Water Supply")%>%
  dplyr::select(-c("Domain"))

names(data.ws) = c("level1", "level2", "size")

data <- read.table(header = T, sep = "-",text = "
level1-level2-size
Erosion-Env.-2.71
Gen.-Env.-21.62
Temp.-Env.-12.6
Gen.-Source-73.63                  
Precip.-Source-17.6                   
Streamflow-Source-10.8
Gen.-I. & D.-10.91
Reservoir-I. & D.-3.64
Storage-I. & D.-5.45
Gen.-Quality-43.47                           
Quality-Quality-8.39                  
Sanitation-Quality-6.11")

sapply(data, class)
windows()
PieDonutCustom(data,
               aes(pies= level2, donuts = level1, count = size),
               ratioByGroup=T,
               addDonutLabel = F,
               labelposition = 1,
               donutLabelSize = 6.5,
               pieLabelSize = 8,
               maxx = 1.7,
               use.labels = F,
               r0=0,showPieName=FALSE)
###############################################################################
## +++++++++++++++++++++++++++++ Water Demand ++++++++++++++++++++++++++++++###
###############################################################################
data.wd = indicator_sum %>% dplyr::filter(Domain == "Factors Influencing Water Demand")%>%
  dplyr::select(-c("Domain"))

data <- read.table(header = T, sep = "-",text = "
level1-level2-size
Food-Ag.-4.91
General-Ag.-28.9
Irrigation-Ag.-3.82
(Arable) Land-Ag.-4.36
Evapotranspiration-Cul. & Env.-2.65
 General-Cul. & Env.-17.6
(Protected) Land-Cul. & Env.-3.53
Nature-Cul. & Env.-3.53                           
 Vegetation-Cul. & Env.-2.65                  
Demand- General-2.92                   
Groundwater- General-8.77                  
Usage- General-7.3              
Industrial-Ind.-4                  
Consumption- Urb. & Mun.-1.54                   
(Urban) Cover- Urb. & Mun.-4.62                  
Domestic- Urb. & Mun.-2.31                   
Upstream- Urb. & Mun.-1.54")

windows()
PieDonutCustom(data,
               aes(pies= level2, donuts = level1, count = size),
               ratioByGroup=T,
               addDonutLabel = F,
               labelposition = 1,
               donutLabelSize = 6.5,
               pieLabelSize = 8,
               maxx = 1.7,
               use.labels = F,
               r0=0,showPieName=FALSE)

###############################################################################
## +++++++++++++++++++++++ Ecosystem & Climate ++++++++++++++++++++++++++++++###
###############################################################################
data.sv = indicator_sum %>% dplyr::filter(Domain == "Factors Influencing the Social Value of Water")%>%
  dplyr::select(-c("Domain"))

data <- read.table(header = T, sep = "/",text = "
level1/level2/size
 General/Economic/27.9
G.D.P./Economic/4.81
Income/Economic/9.62
H.D.I./Economic/3.85
 Agriculture/Economic/3.85
 General/ Inst. & Mgmt./27.08
Government/ Inst. & Mgmt./3.47
Public/ Inst. & Mgmt./2.08
 Civil/ Inst. & Mgmt./2.08
Quality/ Inst. & Mgmt./2.08
Time/ Inst. & Mgmt./2.08
Conflict/ Inst. & Mgmt./2.08
General/Socio-Cultural/72.5
Family/Socio-Cultural/5.93
Population/Socio-Cultural/12.5")

windows()
PieDonutCustom(data,
               aes(pies= level2, donuts = level1, count = size),
               ratioByGroup=T,
               addDonutLabel = F,
               labelposition = 1,
               donutLabelSize = 6.5,
               pieLabelSize = 8,
               maxx = 1.7,
               use.labels = F,
               r0=0,showPieName=FALSE)

library(ggalluvial)
data(vaccinations)
vaccinations <- transform(vaccinations,
                          response = factor(response, rev(levels(response))))


data = read.csv("D:/Projects/Project_Indicators/Data/Spreadsheets/Assessment/Composite_Assessment.csv")

data = data[2:4]
data$count = rep(1)
data = data %>% group_by(Indicator.assessment, Aggregate, Weights) %>%
  dplyr::mutate(Freq = sum(count))

data = data %>% dplyr::select(-c("count"))
names(data) = c("Indicator", "Aggregation", "Weight", "Freq")

## Unique groups
data = as.data.table(data)
data = data[, screen := .GRP, by = c("Indicator", "Aggregation", "Weight")][]
data$screen = as.character(as.numeric(data$screen))
## Set your colors manually
# add color scale information
data <- data %>%
  mutate(color =  plyr::revalue(screen,
                                c(# Min-Max reds
                                  "1" = "#a50f15", 
                                  "10" = "#ef3b2c",
                                  "2" = "#fb6a4a", 
                                  "7" = "#fcbba1",
                                  # Rating Scale
                                  "11" = "#3f007d", 
                                  "14" = "#6a51a3",
                                  "8" = "#9e9ac8", 
                                  "9" = "#dadaeb",
                                  #Basket
                                  "4" = "#0570b0",
                                  #N/A
                                  "3" = "#a1d99b", 
                                  "6" = "#238b45",
                                  # Threshold
                                  "5" = "#ffeda0", # maybe tan 3
                                  # Rank
                                  "12" = "#f768a1", 
                                  #Fractional
                                  "13" = "#bdbdbd"
                                )))

# Color scale
myColorScale <- unique(as.vector(data$color))
names(myColorScale) <- unique(as.vector(data$screen))
colScale <- scale_fill_manual(values = myColorScale)

# current plot
alluvial = ggplot(data = data, aes(y = Freq,
                        axis1 = Indicator, axis2 = Aggregation, axis3 = Weight)) +
  scale_x_discrete(limits = c("Indicator\nStandardization", "Aggregation\nMethod", "Weight"), 
                   labels = c("Indicator\nStandardization", "Aggregation\nMethod", "Weight"),
                   expand = c(.2, .05)) +
  geom_alluvium(aes(fill=screen)) +
  geom_stratum(fill = "white") +
  geom_text(stat = "stratum", infer.label = TRUE, size = 8, fontface = "bold") +
  colScale+
  theme_bw(base_size = 28) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                     panel.background = element_blank(), axis.text.y = element_blank(),
                     axis.title.y = element_blank(), axis.ticks.y = element_blank(),
                     panel.border = element_blank(),
                     legend.position = "none",
                     axis.text.x = element_text(color = "black"),
                     axis.ticks.x = element_blank())
ggsave(plot = alluvial, "D:/Projects/Project_Indicators/Documents/Figures/Assessment/Alluvial.png", 
       width=21, height=17, dpi=300)

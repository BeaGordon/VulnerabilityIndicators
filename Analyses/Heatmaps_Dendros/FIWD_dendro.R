library(tidytext)
library(SemNetCleaner)
library(tm)
library(english)
library(xfun)
library(tidyr)
library(dplyr)
library(stringdist)
library(tidyverse)
library(stringr)
library(extrafont)
library(dendextend)
library(RColorBrewer)
library(ggplot2)
library(tidyr)
library(tibble)
library(hrbrthemes)
library(dplyr)
library(wesanderson)
library(ggdendro)
library(zoo)
library(factoextra)


###############################################################################
## ++++++++++++++++++++++++ Upload Indicators ++++++++++++++++++++++++++++++###
###############################################################################
df.indicators = read.csv("D:/Projects/Project_Indicators/Data/Spreadsheets/Indicators/Indicators_Processed_v5.csv")

source("D:/Projects/Project_Mother/Scripts/kings.R")
source("D:/Projects/Project_Mother/Scripts/map.R")

colors =  c("#bfd3e6", "#9ebcda", "#8c96c6", "#8c6bb1", "#88419d", "#810f7c",
            "#4d004b")
###############################################################################
## ++++++++++++++++++++++ Clean up  Indicators ++++++++++++++++++++++++++++++###
###############################################################################

# deleting punctuations
df.indicators$Indicator<-gsub("[[:punct:][:blank:]]+", " ", df.indicators$Indicator)
# deleting trailing space
df.indicators$Indicator<-gsub("\\n"," ", df.indicators$Indicator)

text= as.character(as.factor(df.indicators$Indicator))
text = tolower(text)
text <- gsub("\n", " ", text)
text <- gsub("^\\s+", "", text)
text <- gsub("\\s+$", "", text)
text <- gsub("[ |\t]+", " ", text)
text <- gsub("[ |\t]+", " ", text)

#text <- gsub('[[:punct:] ]+',"",text)

df.indicators$Indicator_rev <- text
head(df.indicators$Indicator_rev, 10)

# Create dataframe of the stop words
stop_words = read.csv("D:/Projects/Project_Indicators/Data/Spreadsheets/Look-Up Tables/stop_words.csv")

###############################################################################
## +++++++++++++++++++++++++++ Industrial LWUse ++++++++++++++++++++++++++++###
###############################################################################
data.frame.sub = df.indicators %>% dplyr::filter(Sub.Domain == "E")

# Convert to tidy format
tidy_text <- data.frame.sub %>%
  select(Citation, Indicator, Indicator_rev) %>%
  # Tokenize the word from the tweets
  unnest_tokens(input = Indicator_rev, output = word) %>%
  # Remove stop words
  anti_join(stop_words, by="word") %>% ungroup() %>%
  reshape2::melt(id = c("Citation", "Indicator")) 

## remove duplicates
tidy_text = tidy_text %>% group_by(Citation, Indicator) %>%
  distinct(value)

## Regroup
tidy_text_rev = tidy_text %>% group_by(Citation, Indicator)%>%
  dplyr::summarise(Indicator_rev = paste(value, collapse = " "))

## Back to Upper
# tidy_text_rev$Indicator_rev = toupper(tidy_text_rev$Indicator_rev)

data.frame.sub.clusters = map_dfr(tidy_text_rev$Indicator_rev, ~ {
  i <- which(stringdist(., tidy_text_rev$Indicator_rev, "jw") < 0.50)
  tibble(index = i, Indicator = tidy_text_rev$Indicator[i],Indicator_rev = tidy_text_rev$Indicator_rev[i])
}, .id = "group") %>%
  distinct(index, .keep_all = T) %>% 
  mutate(group = as.integer(group))

##+++++++++++++++++++++++++++++++ WORD COUNT SUMMARY +++++++++++++++++++++++++##
## group to see individual indicators
cleaned_text= as.character(as.factor(data.frame.sub.clusters$Indicator_rev))
cleaned_text <- paste(cleaned_text, collapse = " ")
text_df <- data_frame(Text = cleaned_text) 
text_words <- text_df %>% 
  unnest_tokens(output = word, input = Text) 
text_wordcounts <- text_words  %>% dplyr::count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >1,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("s"),]

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  mutate(rank = nrow(data.wordcount) - row_number()+1)

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  dplyr::mutate(percent = (n/sum(n))*100)

data.wordcount$code_rev = ifelse(data.wordcount$percent < 7, "general", data.wordcount$word)

data.wordcount.sum = data.wordcount %>% group_by(code_rev) %>%
  dplyr::summarize(percent.mod = sum(percent),
                   indicator.num = round((percent.mod/100) * nrow(data.frame.sub), digits = 0))

write.csv(data.wordcount.sum, "D:/Projects/Project_Indicators/Data/Spreadsheets/ClusterResults/Indicators_E.csv")

##++++++++++++++++++++++++++++++ CLUSTERING ANALYSIS ++++++++++++++++++++++++##
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicator_rev))
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw")

## Heatmaps for SI
dm.melt = distancemodels %>% reshape2::melt()
names(dm.melt) = c("X", "Y", "Z")
n = length(unique(dm.melt$Z))
pal <- wes_palette("Zissou1", n, type = "continuous")

p1.in = ggplot(dm.melt) + 
  geom_tile(aes(as.character(X), as.character(Y), fill= Z)) +
  scale_fill_gradientn("",colours = pal, limits = c(0,1)) +ylab("")+xlab("")+
  ggtitle("")+
  theme_minimal(base_size = 12)+theme(axis.text.x = element_text(angle = 90),
                                      legend.position = "none")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank())

## Dendrograms for MM
## Substring for plotting
rownames(distancemodels) = str_trunc(toupper(uniquemodels), width = 40, ellipsis = "...")
colnames(distancemodels) = str_trunc(toupper(uniquemodels), width = 40, ellipsis ="...")

## Clustering
d = as.dist(distancemodels)
hc =  hclust(d, "complete")

## Custom Color Palette
colors =  c("#bfd3e6", "#9ebcda", "#8c96c6", "#8c6bb1", "#88419d", "#810f7c",
            "#4d004b")

## Dendrogram
p.in = fviz_dend(hc, h = .5,  
                 type = c("rectangle"),# Cut in four groups
                 cex = 2,  horiz = T, 
                 color_labels_by_k = F,
                 rect = T, lower_rect = 0, 
                 main= "", 
                 palette = c("#bfd3e6", "#9ebcda", "#8c96c6"),
                 rect_border = c("#bfd3e6", "#9ebcda", "#8c96c6"),
                 rect_fill = T, lwd = 1)

## Customize the labels
p.in =   p.in + theme(axis.text.x = element_text(size = 42), 
                      axis.title.x = element_text(size = 42),
                      plot.title = element_text(size = 42))+
  ylab("Jaro-Winkler Distance")+ggtitle("Factors Influencing Water Demand: Industrial Water and Land Use")

## Save the plot
ggsave(plot = p.in,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/IN.jpg", 
       width=21, height=25, dpi=300)

###############################################################################
## +++++++++++++++++++++ Urban/Municipal LWUse ++++++++++++++++++++++++++++###
###############################################################################
data.frame.sub = df.indicators %>% dplyr::filter(Sub.Domain == "F")

# Convert to tidy format
tidy_text <- data.frame.sub %>%
  select(Citation, Indicator, Indicator_rev) %>%
  # Tokenize the word from the tweets
  unnest_tokens(input = Indicator_rev, output = word) %>%
  # Remove stop words
  anti_join(stop_words, by="word") %>% ungroup() %>%
  reshape2::melt(id = c("Citation", "Indicator")) 

## remove duplicates
tidy_text = tidy_text %>% group_by(Citation, Indicator) %>%
  distinct(value)

## Regroup
tidy_text_rev = tidy_text %>% group_by(Citation, Indicator)%>%
  dplyr::summarise(Indicator_rev = paste(value, collapse = " "))

## Back to Upper
# tidy_text_rev$Indicator_rev = toupper(tidy_text_rev$Indicator_rev)

data.frame.sub.clusters = map_dfr(tidy_text_rev$Indicator_rev, ~ {
  i <- which(stringdist(., tidy_text_rev$Indicator_rev, "jw") < 0.50)
  tibble(index = i, Indicator = tidy_text_rev$Indicator[i],Indicator_rev = tidy_text_rev$Indicator_rev[i])
}, .id = "group") %>%
  distinct(index, .keep_all = T) %>% 
  mutate(group = as.integer(group))

##+++++++++++++++++++++++++++++++ WORD COUNT SUMMARY +++++++++++++++++++++++++##
## group to see individual indicators
cleaned_text= as.character(as.factor(data.frame.sub.clusters$Indicator_rev))
cleaned_text <- paste(cleaned_text, collapse = " ")
text_df <- data_frame(Text = cleaned_text) 
text_words <- text_df %>% 
  unnest_tokens(output = word, input = Text) 
text_wordcounts <- text_words  %>% dplyr::count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >1,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("s"),]

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  mutate(rank = nrow(data.wordcount) - row_number()+1)

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  dplyr::mutate(percent = (n/sum(n))*100)

data.wordcount$code_rev = ifelse(data.wordcount$percent < 7, "general", data.wordcount$word)

data.wordcount.sum = data.wordcount %>% group_by(code_rev) %>%
  dplyr::summarize(percent.mod = sum(percent),
                   indicator.num = round((percent.mod/100) * nrow(data.frame.sub), digits = 0))

write.csv(data.wordcount.sum, "D:/Projects/Project_Indicators/Data/Spreadsheets/ClusterResults/Indicators_F.csv")

##++++++++++++++++++++++++++++++ CLUSTERING ANALYSIS ++++++++++++++++++++++++##
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicator_rev))
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw")

## Heatmaps for SI
dm.melt = distancemodels %>% reshape2::melt()
names(dm.melt) = c("X", "Y", "Z")
n = length(unique(dm.melt$Z))
pal <- wes_palette("Zissou1", n, type = "continuous")

p1.um = ggplot(dm.melt) + 
  geom_tile(aes(as.character(X), as.character(Y), fill= Z)) +
  scale_fill_gradientn("",colours = pal, limits = c(0,1)) +ylab("")+xlab("")+
  ggtitle("")+
  theme_minimal(base_size = 12)+theme(axis.text.x = element_text(angle = 90),
                                      legend.position = "none")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank())

## Dendrograms for MM
## Substring for plotting
rownames(distancemodels) = str_trunc(toupper(uniquemodels), width = 40, ellipsis = "...")
colnames(distancemodels) = str_trunc(toupper(uniquemodels), width = 40, ellipsis ="...")

## Clustering
d = as.dist(distancemodels)
hc =  hclust(d, "complete")

## Custom Color Palette
colors =  c("#bfd3e6", "#9ebcda", "#8c96c6", "#8c6bb1", "#88419d", "#810f7c",
            "#4d004b")

## Dendrogram
p.um = fviz_dend(hc, h = .5,  
                 type = c("rectangle"),# Cut in four groups
                 cex = 2,  horiz = T, 
                 color_labels_by_k = F,
                 rect = T, lower_rect = 0, 
                 main= "", 
                 palette = c("#bfd3e6", "#9ebcda", "#8c96c6", "#8c6bb1", "#88419d"),
                 rect_border = c("#bfd3e6", "#9ebcda", "#8c96c6", "#8c6bb1", "#88419d"),
                 rect_fill = T, lwd = 1)

## Customize the labels
p.um =   p.um + theme(axis.text.x = element_text(size = 42), 
                      axis.title.x = element_text(size = 42),
                      plot.title = element_text(size = 42))+
  ylab("Jaro-Winkler Distance")+ggtitle("Factors Influencing Water Demand: Urban and Muncipal Water and Land Use")

## Save the plot
ggsave(plot = p.um,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/UM.jpg", 
       width=21, height=25, dpi=300)

###############################################################################
## ++++++++++++++++++++++ Agricultural LWUse  ++++++++++++++++++++++++++++++###
###############################################################################
data.frame.sub = df.indicators %>% dplyr::filter(Sub.Domain == "G")

# Convert to tidy format
tidy_text <- data.frame.sub %>%
  select(Citation, Indicator, Indicator_rev) %>%
  # Tokenize the word from the tweets
  unnest_tokens(input = Indicator_rev, output = word) %>%
  # Remove stop words
  anti_join(stop_words, by="word") %>% ungroup() %>%
  reshape2::melt(id = c("Citation", "Indicator")) 

## remove duplicates
tidy_text = tidy_text %>% group_by(Citation, Indicator) %>%
  distinct(value)

## Regroup
tidy_text_rev = tidy_text %>% group_by(Citation, Indicator)%>%
  dplyr::summarise(Indicator_rev = paste(value, collapse = " "))

## Back to Upper
# tidy_text_rev$Indicator_rev = toupper(tidy_text_rev$Indicator_rev)

data.frame.sub.clusters = map_dfr(tidy_text_rev$Indicator_rev, ~ {
  i <- which(stringdist(., tidy_text_rev$Indicator_rev, "jw") < 0.50)
  tibble(index = i, Indicator = tidy_text_rev$Indicator[i],Indicator_rev = tidy_text_rev$Indicator_rev[i])
}, .id = "group") %>%
  distinct(index, .keep_all = T) %>% 
  mutate(group = as.integer(group))

##+++++++++++++++++++++++++++++++ WORD COUNT SUMMARY +++++++++++++++++++++++++##
## group to see individual indicators
cleaned_text= as.character(as.factor(data.frame.sub.clusters$Indicator_rev))
cleaned_text <- paste(cleaned_text, collapse = " ")
text_df <- data_frame(Text = cleaned_text) 
text_words <- text_df %>% 
  unnest_tokens(output = word, input = Text) 
text_wordcounts <- text_words  %>% dplyr::count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >1,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("s"),]

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  mutate(rank = nrow(data.wordcount) - row_number()+1)

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  dplyr::mutate(percent = (n/sum(n))*100)

data.wordcount$code_rev = ifelse(data.wordcount$percent < 7, "general", data.wordcount$word)

data.wordcount.sum = data.wordcount %>% group_by(code_rev) %>%
  dplyr::summarize(percent.mod = sum(percent),
                   indicator.num = round((percent.mod/100) * nrow(data.frame.sub), digits = 0))

write.csv(data.wordcount.sum, "D:/Projects/Project_Indicators/Data/Spreadsheets/ClusterResults/Indicators_G.csv")

##++++++++++++++++++++++++++++++ CLUSTERING ANALYSIS ++++++++++++++++++++++++##
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicator_rev))
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw")

## Heatmaps for SI
dm.melt = distancemodels %>% reshape2::melt()
names(dm.melt) = c("X", "Y", "Z")
n = length(unique(dm.melt$Z))
pal <- wes_palette("Zissou1", n, type = "continuous")

p1.ag = ggplot(dm.melt) + 
  geom_tile(aes(as.character(X), as.character(Y), fill= Z)) +
  scale_fill_gradientn("",colours = pal, limits = c(0,1)) +ylab("")+xlab("")+
  ggtitle("")+
  theme_minimal(base_size = 12)+theme(axis.text.x = element_text(angle = 90),
                                      legend.position = "none")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank())

## Dendrograms for MM
## Substring for plotting
rownames(distancemodels) = str_trunc(toupper(uniquemodels), width = 40, ellipsis = "...")
colnames(distancemodels) = str_trunc(toupper(uniquemodels), width = 40, ellipsis ="...")

## Clustering
d = as.dist(distancemodels)
hc =  hclust(d, "complete")

## Custom Color Palette
colors =  c("#bfd3e6", "#9ebcda", "#8c96c6", "#8c6bb1", "#88419d", "#810f7c",
            "#4d004b")

## Dendrogram
p.ag = fviz_dend(hc, h = .5,  
                 type = c("rectangle"),# Cut in four groups
                 cex = 2,  horiz = T, 
                 color_labels_by_k = F,
                 rect = T, lower_rect = 0, 
                 main= "", 
                 palette = c("#bfd3e6", "#9ebcda", "#8c96c6", "#8c6bb1","mediumorchid4", 
                             "#88419d","mediumpurple4", "#810f7c", 
                             "#4d004b"),
                 rect_border = c("#bfd3e6", "#9ebcda", "#8c96c6", "#8c6bb1","mediumorchid4", 
                                 "#88419d","mediumpurple4", "#810f7c", 
                                 "#4d004b"),
                 rect_fill = T, lwd = 1)

## Customize the labels
p.ag =   p.ag + theme(axis.text.x = element_text(size = 42), 
                      axis.title.x = element_text(size = 42),
                      plot.title = element_text(size = 42))+
  ylab("Jaro-Winkler Distance")+ggtitle("Factors Influencing Water Demand: Agricultural Water and Land Use")

## Save the plot
ggsave(plot = p.ag,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/AG.jpg", 
       width=21, height=25, dpi=300)

###############################################################################
## +++++++++++++++ Environmental/Cultural LWUse  +++++++++++++++++++++++++++###
###############################################################################
data.frame.sub = df.indicators %>% dplyr::filter(Sub.Domain == "H")

# Convert to tidy format
tidy_text <- data.frame.sub %>%
  select(Citation, Indicator, Indicator_rev) %>%
  # Tokenize the word from the tweets
  unnest_tokens(input = Indicator_rev, output = word) %>%
  # Remove stop words
  anti_join(stop_words, by="word") %>% ungroup() %>%
  reshape2::melt(id = c("Citation", "Indicator")) 

## remove duplicates
tidy_text = tidy_text %>% group_by(Citation, Indicator) %>%
  distinct(value)

## Regroup
tidy_text_rev = tidy_text %>% group_by(Citation, Indicator)%>%
  dplyr::summarise(Indicator_rev = paste(value, collapse = " "))

## Back to Upper
# tidy_text_rev$Indicator_rev = toupper(tidy_text_rev$Indicator_rev)

data.frame.sub.clusters = map_dfr(tidy_text_rev$Indicator_rev, ~ {
  i <- which(stringdist(., tidy_text_rev$Indicator_rev, "jw") < 0.50)
  tibble(index = i, Indicator = tidy_text_rev$Indicator[i],Indicator_rev = tidy_text_rev$Indicator_rev[i])
}, .id = "group") %>%
  distinct(index, .keep_all = T) %>% 
  mutate(group = as.integer(group))

##+++++++++++++++++++++++++++++++ WORD COUNT SUMMARY +++++++++++++++++++++++++##
cleaned_text= as.character(as.factor(data.frame.sub.clusters$Indicator_rev))
cleaned_text <- paste(cleaned_text, collapse = " ")
text_df <- data_frame(Text = cleaned_text) 
text_words <- text_df %>% 
  unnest_tokens(output = word, input = Text) 
text_wordcounts <- text_words  %>% dplyr::count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >1,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("s"),]

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  mutate(rank = nrow(data.wordcount) - row_number()+1)

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  dplyr::mutate(percent = (n/sum(n))*100)

data.wordcount$code_rev = ifelse(data.wordcount$percent < 7, "general", data.wordcount$word)

data.wordcount.sum = data.wordcount %>% group_by(code_rev) %>%
  dplyr::summarize(percent.mod = sum(percent),
                   indicator.num = round((percent.mod/100) * nrow(data.frame.sub), digits = 0))

write.csv(data.wordcount.sum, "D:/Projects/Project_Indicators/Data/Spreadsheets/ClusterResults/Indicators_H.csv")

##++++++++++++++++++++++++++++++ CLUSTERING ANALYSIS ++++++++++++++++++++++++##
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicator_rev))
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw")

## Heatmaps for SI
dm.melt = distancemodels %>% reshape2::melt()
names(dm.melt) = c("X", "Y", "Z")
n = length(unique(dm.melt$Z))
pal <- wes_palette("Zissou1", n, type = "continuous")

p1.EC = ggplot(dm.melt) + 
  geom_tile(aes(as.character(X), as.character(Y), fill= Z)) +
  scale_fill_gradientn("",colours = pal, limits = c(0,1)) +ylab("")+xlab("")+
  ggtitle("")+
  theme_minimal(base_size = 12)+theme(axis.text.x = element_text(angle = 90),
                                      legend.position = "none")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank())
## Dendrograms for MM
## Substring for plotting
rownames(distancemodels) = str_trunc(toupper(uniquemodels), width = 40, ellipsis = "...")
colnames(distancemodels) = str_trunc(toupper(uniquemodels), width = 40, ellipsis ="...")

## Clustering
d = as.dist(distancemodels)
hc =  hclust(d, "complete")

## Custom Color Palette
colors =  c("#bfd3e6", "#9ebcda", "#8c96c6", "#8c6bb1","mediumorchid4", 
            "#88419d","mediumpurple4", "#810f7c", 
            "#4d004b")

## Dendrogram
p.EC= fviz_dend(hc, h = .5,  
                 type = c("rectangle"),# Cut in four groups
                 cex = 2,  horiz = T, 
                 color_labels_by_k = F,
                 rect = T, lower_rect = 0, 
                 main= "", 
                 palette = c("#bfd3e6", "#9ebcda", "#8c96c6", "#4d004b","mediumorchid4", 
                             "#88419d","mediumpurple4", "#810f7c"),
                 rect_border = c("#bfd3e6", "#9ebcda", "#8c96c6", "#4d004b","mediumorchid4", 
                                 "#88419d","mediumpurple4", "#810f7c"),
                 rect_fill = T, lwd = 1)

## Customize the labels
p.EC =   p.EC + theme(axis.text.x = element_text(size = 42), 
                        axis.title.x = element_text(size = 42),
                        plot.title = element_text(size = 42))+
  ylab("Jaro-Winkler Distance")+ggtitle("Factors Influencing Water Demand: Environmental and Cultural Water and Land Use")

## Save the plot
ggsave(plot = p.EC,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/Water_EC.jpg", 
       width=21, height=25, dpi=300)

###############################################################################
## +++++++++++++++++++++++++++++++ General LWUse +++++++++++++++++++++++++++###
###############################################################################
data.frame.sub = df.indicators %>% dplyr::filter(Sub.Domain == "I")

# Convert to tidy format
tidy_text <- data.frame.sub %>%
  select(Citation, Indicator, Indicator_rev) %>%
  # Tokenize the word from the tweets
  unnest_tokens(input = Indicator_rev, output = word) %>%
  # Remove stop words
  anti_join(stop_words, by="word") %>% ungroup() %>%
  reshape2::melt(id = c("Citation", "Indicator")) 

## remove duplicates
tidy_text = tidy_text %>% group_by(Citation, Indicator) %>%
  distinct(value)

## Regroup
tidy_text_rev = tidy_text %>% group_by(Citation, Indicator)%>%
  dplyr::summarise(Indicator_rev = paste(value, collapse = " "))

## Back to Upper
# tidy_text_rev$Indicator_rev = toupper(tidy_text_rev$Indicator_rev)

data.frame.sub.clusters = map_dfr(tidy_text_rev$Indicator_rev, ~ {
  i <- which(stringdist(., tidy_text_rev$Indicator_rev, "jw") < 0.50)
  tibble(index = i, Indicator = tidy_text_rev$Indicator[i],Indicator_rev = tidy_text_rev$Indicator_rev[i])
}, .id = "group") %>%
  distinct(index, .keep_all = T) %>% 
  mutate(group = as.integer(group))

##+++++++++++++++++++++++++++++++ WORD COUNT SUMMARY +++++++++++++++++++++++++##
cleaned_text= as.character(as.factor(data.frame.sub.clusters$Indicator_rev))
cleaned_text <- paste(cleaned_text, collapse = " ")
text_df <- data_frame(Text = cleaned_text) 
text_words <- text_df %>% 
  unnest_tokens(output = word, input = Text) 
text_wordcounts <- text_words  %>% dplyr::count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >1,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("s"),]

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  mutate(rank = nrow(data.wordcount) - row_number()+1)

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  dplyr::mutate(percent = (n/sum(n))*100)

data.wordcount$code_rev = ifelse(data.wordcount$percent < 7, "general", data.wordcount$word)

data.wordcount.sum = data.wordcount %>% group_by(code_rev) %>%
  dplyr::summarize(percent.mod = sum(percent),
                   indicator.num = round((percent.mod/100) * nrow(data.frame.sub), digits = 0))

write.csv(data.wordcount.sum, "D:/Projects/Project_Indicators/Data/Spreadsheets/ClusterResults/Indicators_I.csv")

##++++++++++++++++++++++++++++++ CLUSTERING ANALYSIS ++++++++++++++++++++++++##
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicator_rev))
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw")

## Heatmaps for SI
dm.melt = distancemodels %>% reshape2::melt()
names(dm.melt) = c("X", "Y", "Z")
n = length(unique(dm.melt$Z))
pal <- wes_palette("Zissou1", n, type = "continuous")

p1.GE = ggplot(dm.melt) + 
  geom_tile(aes(as.character(X), as.character(Y), fill= Z)) +
  scale_fill_gradientn("",colours = pal, limits = c(0,1)) +ylab("")+xlab("")+
  ggtitle("")+
  theme_minimal(base_size = 12)+theme(axis.text.x = element_text(angle = 90),
                                      legend.position = "none")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank())

## Dendrograms for MM
## Substring for plotting
rownames(distancemodels) = str_trunc(toupper(uniquemodels), width = 40, ellipsis = "...")
colnames(distancemodels) = str_trunc(toupper(uniquemodels), width = 40, ellipsis ="...")

## Clustering
d = as.dist(distancemodels)
hc =  hclust(d, "complete")

## Custom Color Palette
colors =  c("#bfd3e6", "#9ebcda", "#8c96c6", "#8c6bb1","mediumorchid4", 
            "#88419d","mediumpurple4", "#810f7c", 
            "#4d004b")

## Dendrogram
p.GE= fviz_dend(hc, h = .5,  
                type = c("rectangle"),# Cut in four groups
                cex = 2,  horiz = T, 
                color_labels_by_k = F,
                rect = T, lower_rect = 0, 
                main= "", 
                palette = c("#bfd3e6", "#9ebcda", "#8c96c6", "mediumorchid4", 
                            "#88419d"),
                rect_border = c("#bfd3e6", "#9ebcda", "#8c96c6", "mediumorchid4", 
                                "#88419d"),
                rect_fill = T, lwd = 1)

## Customize the labels
p.GE =  p.GE + theme(axis.text.x = element_text(size = 42), 
                     axis.title.x = element_text(size = 42),
                     plot.title = element_text(size = 42))+
  ylab("Jaro-Winkler Distance")+ggtitle("Factors Influencing Water Demand: General Water and Land Use")

## Save the plot
ggsave(plot = p.GE,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/Water_GE.jpg", 
       width=21, height=25, dpi=300)

###############################################################################
## ++++++++++++++++++++++ Combined plots of hm &dg  ++++++++++++++++++++++++###
###############################################################################   
## Get a legend
p1.GE.legend = ggplot(dm.melt) + 
  geom_tile(aes(as.character(X), as.character(Y), fill= Z)) +
  scale_fill_gradientn("Jaro-Winkler Distance",colours = pal, limits = c(0,1)) +ylab("")+xlab("")+
  ggtitle("")+
  theme_minimal(base_size = 28)+theme(axis.text.x = element_text(angle = 90))+
  theme(legend.key.height = unit(1, "cm"),
        legend.key.width = unit(4, "cm"))+
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5))

legend.1 = get_legend(p1.GE.legend+theme(legend.position = "bottom", legend.title.align = 0.5))

## make the plot
windows()
plot =      
  cowplot::ggdraw() +
  cowplot::draw_plot(p1.um,x=0,  y = 0.5+0.02, width =0.45, height= 0.45) + 
  cowplot::draw_plot(p1.ag,x=0.5, y=0.5+0.02, width =0.45, height= 0.45) + 
  cowplot::draw_plot(p1.EC,x=0, y=0+0.1, width =0.45, height= 0.4)+
  cowplot::draw_plot(p1.GE,x=0.5,  y = 0+0.1, width =0.45, height= 0.4)+
  cowplot::draw_plot(legend.1,x = 0.25, y= 0-0.15, width = 0.45, height = 0.45)+
  cowplot::draw_label("Urban/Municipal Land and Water Use", size = 28, 
                      fontfamily = "Helvetica", x= 0.22, y = 0.95+0.02)+
  cowplot::draw_label("Agricultural Land and Water Use", size = 28, 
                      fontfamily = "Helvetica", x= 0.75, y = 0.95+0.02)+
  cowplot::draw_label("Environmental/Cultural Land and Water Use", size = 28, 
                      fontfamily = "Helvetica", x= 0.25, y = 0.45+0.05)+
  cowplot::draw_label("General Land and Water Use", size = 28, 
                      fontfamily = "Helvetica", x= 0.75, y = 0.45+0.05)+
  cowplot::draw_label("A", size = 28, 
                      fontfamily = "Helvetica", x= 0.05, y = 0.95+0.02)+
  cowplot::draw_label("B", size = 28, 
                      fontfamily = "Helvetica", x= 0.55, y = 0.95+0.02)+
  cowplot::draw_label("C", size = 28, 
                      fontfamily = "Helvetica", x= 0.05, y = 0.45+0.05)+
  cowplot::draw_label("D", size = 28, 
                      fontfamily = "Helvetica", x= 0.55, y = 0.45+0.05)

ggsave(plot = plot,"D:/Projects/Project_Indicators/Documents/Figures/Heatmaps/FIWD.jpg", 
       width=21, height=25, dpi=300)

library(tidytext)
library(SemNetCleaner)
library(tm)
library(english)
library(xfun)
library(tidyr)
library(dplyr)
library(stringdist)
library(tidyverse)
library(stringr)
library(extrafont)
library(dendextend)
library(RColorBrewer)
library(ggplot2)
library(tidyr)
library(tibble)
library(hrbrthemes)
library(dplyr)
library(wesanderson)
library(ggdendro)
library(zoo)
library(factoextra)
library(parameters)
library(ggpubr)
library(mclust)
library(NbClust)

###############################################################################
## ++++++++++++++++++++++++ Upload Indicators ++++++++++++++++++++++++++++++###
###############################################################################
df.indicators = read.csv("D:/Projects/Project_Indicators/Data/Spreadsheets/Indicators/Indicators_Processed_v5.csv")

source("D:/Projects/Project_Mother/Scripts/kings.R")
source("D:/Projects/Project_Mother/Scripts/map.R")
source("D:/Projects/Project_Indicators/Scripts/Indicators/Fviz_dend_v2.R")
source("D:/Projects/Project_Indicators/Scripts/Indicators/Fviz_dend_ref.R")


colors =  c("#f7fbff", "#deebf7", "#d0d1e6", "#c6dbef", "#9ecae1", "#6baed6", "#4292c6",
            "#74a9cf", "#2171b5","#08519c", "#08306b", "#0570b0")
###############################################################################
## ++++++++++++++++++++++ Clean up  Indicators ++++++++++++++++++++++++++++++###
###############################################################################

# deleting punctuations
df.indicators$Indicator<-gsub("[[:punct:][:blank:]]+", " ", df.indicators$Indicator)
# deleting trailing space
df.indicators$Indicator<-gsub("\\n"," ", df.indicators$Indicator)

text= as.character(as.factor(df.indicators$Indicator))
text = tolower(text)
text <- gsub("\n", " ", text)
text <- gsub("^\\s+", "", text)
text <- gsub("\\s+$", "", text)
text <- gsub("[ |\t]+", " ", text)
text <- gsub("[ |\t]+", " ", text)

#text <- gsub('[[:punct:] ]+',"",text)

df.indicators$Indicator_rev <- text
head(df.indicators$Indicator_rev, 10)

# Create dataframe of the stop words
stop_words = read.csv("D:/Projects/Project_Indicators/Data/Spreadsheets/Look-Up Tables/stop_words.csv")

###############################################################################
## ++++++++++++++++++++++ WATER SOURCE PROCESS ++++++++++++++++++++++++++++++###
###############################################################################
data.frame.sub = df.indicators %>% dplyr::filter(Sub.Domain == "A")

# Convert to tidy format
tidy_text <- data.frame.sub %>%
  select(Citation, Indicator, Indicator_rev) %>%
  # Tokenize the word from the tweets
  unnest_tokens(input = Indicator_rev, output = word) %>%
  # Remove stop words
  anti_join(stop_words, by="word") %>% ungroup() %>%
  reshape2::melt(id = c("Citation", "Indicator")) 

## remove duplicates
tidy_text = tidy_text %>% group_by(Citation, Indicator) %>%
  distinct(value)

## Regroup
tidy_text_rev = tidy_text %>% group_by(Citation, Indicator)%>%
  dplyr::summarise(Indicator_rev = paste(value, collapse = " "))

# Convert words 
tidy_text_rev$Indicator_rev = ifelse(tidy_text_rev$Indicator_rev == "waterresourcesvariability",
                                     "water resources", tidy_text_rev$Indicator_rev)

tidy_text_rev$Indicator_rev = ifelse(tidy_text_rev$Indicator_rev == "largeststreamflow",
                                     "streamflow", tidy_text_rev$Indicator_rev)

tidy_text_rev$Indicator_rev = ifelse(tidy_text_rev$Indicator_rev == "smalleststreamflow",
                                     "streamflow", tidy_text_rev$Indicator_rev)

## Back to Upper
# tidy_text_rev$Indicator_rev = toupper(tidy_text_rev$Indicator_rev)

data.frame.sub.clusters = map_dfr(tidy_text_rev$Indicator_rev, ~ {
  i <- which(stringdist(., tidy_text_rev$Indicator_rev, "jw") < 0.50)
  tibble(index = i, Indicator = tidy_text_rev$Indicator[i],Indicator_rev = tidy_text_rev$Indicator_rev[i])
}, .id = "group") %>%
  distinct(index, .keep_all = T) %>% 
  mutate(group = as.integer(group))
##+++++++++++++++++++++++++++++++ WORD COUNT SUMMARY +++++++++++++++++++++++++##
## group to see individual indicators
cleaned_text= as.character(as.factor(data.frame.sub.clusters$Indicator_rev))
cleaned_text <- paste(cleaned_text, collapse = " ")
text_df <- data_frame(Text = cleaned_text) 
text_words <- text_df %>% 
  unnest_tokens(output = word, input = Text) 
text_wordcounts <- text_words  %>% dplyr::count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >1,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("s"),]

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  mutate(rank = nrow(data.wordcount) - row_number()+1)

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  dplyr::mutate(percent = (n/sum(n))*100)

data.wordcount$code_rev = ifelse(data.wordcount$percent < 7, "general", data.wordcount$word)

data.wordcount.sum = data.wordcount %>% group_by(code_rev) %>%
  dplyr::summarize(percent.mod = sum(percent),
                   indicator.num = (percent.mod/100) * nrow(data.frame.sub), digits = 0)

write.csv(data.wordcount.sum, "D:/Projects/Project_Indicators/Data/Spreadsheets/ClusterResults/Indicators_A.csv")

##++++++++++++++++++++++++++++++ CLUSTERING ANALYSIS ++++++++++++++++++++++++##
##+
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicator_rev))
# uniquemodels = str_remove(uniquemodels, "water")
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw", p = 0.1)

## Heatmaps for SI
dm.melt = distancemodels %>% reshape2::melt()
names(dm.melt) = c("X", "Y", "Z")
n = length(unique(dm.melt$Z))
pal <- wes_palette("Zissou1", n, type = "continuous")
windows()
p1.ws = ggplot(dm.melt) + 
  geom_tile(aes(as.character(X), as.character(Y), fill= Z)) +
  scale_fill_distiller("",palette = "Blues", limits = c(0,1)) +ylab("")+xlab("")+
  ggtitle("")+
  theme_minimal(base_size = 12)+theme(axis.text = element_blank(),
                                      legend.position = "none")

##++++++++++++++++++++++++++++++ DENDROGRAMS SETUP +++++++++++++++++++++++++++##
## Substring for plotting
rownames(distancemodels) = toupper(uniquemodels)
colnames(distancemodels) = toupper(uniquemodels)

## Clustering
d = as.dist(distancemodels)
hc =  hclust(d, "complete")

distancemodels = as.data.frame(distancemodels)

n_clusters(distancemodels,
           package = c("easystats", "NbClust", "mclust"),
           standardize = FALSE)

## Optimal Number of clusters (Silhouette)
cl.ws.sil = fviz_nbclust(distancemodels, kmeans,
                         nstart = 25,k.max = 15,
                         method = "silhouette") +
  labs(subtitle = "Water Source Clusters (Silhouette)")+theme(axis.text = element_text(size = 28),
                                                              plot.title = element_text(size = 32),
                                                              axis.title = element_text(size = 28),
                                                              plot.subtitle = element_text(size = 28))

cl.ws.wss = fviz_nbclust(distancemodels, kmeans,
                         nstart = 25,k.max = 15,
                         method = "wss") +
  labs(subtitle = "Water Source Clusters (Elbow)")+theme(axis.text = element_text(size = 28),
                                                         plot.title = element_text(size = 32),
                                                         axis.title = element_text(size = 28),
                                                         plot.subtitle = element_text(size = 28))

## Establish your reference set for clustering
ref.ws = fviz_dend_ref(hc, k = 11,  
                       type = c("rectangle"),# Cut in four groups
                       cex = 2,  horiz = T, 
                       color_labels_by_k = F, 
                       rect = T, lower_rect = 0, 
                       main= "", 
                       palette = c("dodgerblue4",  "mediumpurple4","thistle4", "palevioletred",
                                   "coral3","orangered2",  
                                   "darkgoldenrod3", "lightsalmon1", "olivedrab3",
                                   "forestgreen"),
                       # rect_border = c("dodgerblue4",  "mediumpurple4","thistle4", "palevioletred",
                       #                 "coral3","orangered2",  
                       #                 "darkgoldenrod3", "lightsalmon1", "olivedrab3",
                       #                 "forestgreen"),
                       rect_fill = T, lwd = 1)

ref.ws =   ref.ws + theme(axis.text.x = element_text(size = 32), 
                          axis.title.x = element_text(size = 32),
                          plot.title = element_text(size = 32))+
  ylab("Jaro-Winkler Distance")

## Save the plot
ggsave(plot = ref.ws,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/Reference/WS.jpg",
       width=25, height=25, dpi=300)

## function to get results
lv <- function() .Last.value

## Dendrogram labels 
fviz_dend_labels(hc, k = 11,  
                 type = c("rectangle"),# Cut in four groups
                 cex = 2,  horiz = T, 
                 color_labels_by_k = F, show_labels = F,
                 rect = T, lower_rect = 0, 
                 main= "", 
                 palette = c( "#a6bddb","#74a9cf", "#3690c0","dodgerblue3",
                              "#0570b0","#045a8d", "royalblue3", "darkblue", 
                              "navyblue", 
                              "midnightblue","#023858"),
                 # rect_border = c("#a6bddb","#74a9cf", "#3690c0","dodgerblue3",
                 #                 "#0570b0","#045a8d", "royalblue3", "darkblue", 
                 #                 "navyblue", 
                 #                 "midnightblue","#023858"),
                 rect_fill = T, lwd = 1)

## Now build out the text analysis 
result = lv()
names(result) = c("text")
result$count = rownames(result)
result$count = as.numeric(as.character(result$count))

## Sadly until you can figure out how to automate, you need to manually code 
## the clusters for text analysis
result$cluster = ifelse(result$count==c(1:13), "1",
                        ifelse(result$count >=14 & result$count <=18, "2",
                               ifelse(result$count >=19 & result$count <=25, "3",
                                      ifelse(result$count >=26 & result$count <=28, "4",
                                             ifelse(result$count >=29 & result$count <=34, "5",
                                                    ifelse(result$count >=35 & result$count <=46, "6",
                                                           ifelse(result$count >=47 & result$count <=56, "7",
                                                                  ifelse(result$count >=57 & result$count <=62, "8",
                                                                         ifelse(result$count >=63 & result$count <=66, "9",
                                                                                "10")))))))))

##+++++++++++++++++++++++++++++++ WORD COUNT SUMMARY +++++++++++++++++++++++++##
## group to see individual indicators
result$text = as.character(as.factor(result$text))
results.ls = split(result, f= result$cluster)
results.ls = purrr::map(results.ls, ~ (.x %>% select(-count)))
results.ls = purrr::map(results.ls, ~ (.x %>% select(-cluster)))
results.ls = lapply(results.ls, paste, collapse = " ")
list_chars_as_tibble <- lapply(results.ls, function(x) tibble(txt = x))
results.ls = lapply(list_chars_as_tibble, unnest_tokens, word, txt)
map.dat = Map(cbind, results.ls, ID = names(results.ls))
results.df = do.call(rbind.data.frame, map.dat)

text_wordcounts = results.df %>% group_by(ID) %>%
  dplyr::count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >0,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("c"),]

## Extract the max number for each cluster
data.wordcount.sum = data.wordcount %>% group_by(ID) %>%
  dplyr::mutate(Max = max(n)) %>%
  dplyr::filter(n == Max) 

labels = aggregate(word ~ ID, unique(data.wordcount.sum), paste, collapse = " ")
write.csv(labels, "D:/Projects/Project_Indicators/Documents/Figures/Dendograms/Label_A.csv")

## Customize the plot and labels
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicator_rev))
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw", p = 0.1)
x= rep(1, 70)
distancemodels = rbind(distancemodels,x)
distancemodels = cbind(distancemodels,x)

## Clustering
d = as.dist(distancemodels)
hc =  hclust(d, "complete")

p.ws = fviz_dend(hc, k = 12, 
                 # type = c("rectangle"),# Cut in four groups
                 cex = 2,  horiz = T, 
                 color_labels_by_k = T,
                 rect = T,lower_rect = 0,show_labels = F,
                 main= "",
                 palette = "jco",rect_border = "jco",
                 rect_fill = TRUE, lwd = .75)

p.ws =   p.ws + theme(axis.text.x = element_text(size = 32), 
                      axis.title.x = element_text(size = 32),
                      plot.title = element_text(size = 32))+
  ylab("")
windows()

###############################################################################
## ++++++++++++++++++++++ Water Quality Process  +++++++++++++++++++++++++++###
###############################################################################
data.frame.sub = df.indicators %>% dplyr::filter(Sub.Domain == "B")

# Convert to tidy format
tidy_text <- data.frame.sub %>%
  select(Citation, Indicator, Indicator_rev) %>%
  # Tokenize the word from the tweets
  unnest_tokens(input = Indicator_rev, output = word) %>%
  # Remove stop words
  anti_join(stop_words, by="word") %>% ungroup() %>%
  reshape2::melt(id = c("Citation", "Indicator")) 

## remove duplicates
tidy_text = tidy_text %>% group_by(Citation, Indicator) %>%
  distinct(value)

## Regroup
tidy_text_rev = tidy_text %>% group_by(Citation, Indicator)%>%
  dplyr::summarise(Indicator_rev = paste(value, collapse = " "))

# Convert words 
tidy_text_rev$Indicator_rev = ifelse(tidy_text_rev$Indicator_rev == "biochemicaloxygendemand",
                                     "biochemical oxygen demand", tidy_text_rev$Indicator_rev)

tidy_text_rev$Indicator_rev = ifelse(tidy_text_rev$Indicator_rev == "phosphorus concentration",
                                     "phosphorous concentration", tidy_text_rev$Indicator_rev)

## Back to Upper
# tidy_text_rev$Indicator_rev = toupper(tidy_text_rev$Indicator_rev)

data.frame.sub.clusters = map_dfr(tidy_text_rev$Indicator_rev, ~ {
  i <- which(stringdist(., tidy_text_rev$Indicator_rev, "jw") < 0.50)
  tibble(index = i, Indicator = tidy_text_rev$Indicator[i],Indicator_rev = tidy_text_rev$Indicator_rev[i])
}, .id = "group") %>%
  distinct(index, .keep_all = T) %>% 
  mutate(group = as.integer(group))

##+++++++++++++++++++++++++++++++ WORD COUNT SUMMARY +++++++++++++++++++++++++##
## group to see individual indicators
cleaned_text= as.character(as.factor(data.frame.sub.clusters$Indicator_rev))
cleaned_text <- paste(cleaned_text, collapse = " ")
text_df <- data_frame(Text = cleaned_text) 
text_words <- text_df %>% 
  unnest_tokens(output = word, input = Text) 
text_wordcounts <- text_words  %>% dplyr::count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >1,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("s"),]

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  mutate(rank = nrow(data.wordcount) - row_number()+1)

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  dplyr::mutate(percent = (n/sum(n))*100)

data.wordcount$code_rev = ifelse(data.wordcount$percent < 7, "general", data.wordcount$word)

data.wordcount.sum = data.wordcount %>% group_by(code_rev) %>%
  dplyr::summarize(percent.mod = sum(percent),
                   (percent.mod/100) * nrow(data.frame.sub), digits = 0)

write.csv(data.wordcount.sum, "D:/Projects/Project_Indicators/Data/Spreadsheets/ClusterResults/Indicators_B.csv")

##++++++++++++++++++++++++++++++ CLUSTERING ANALYSIS ++++++++++++++++++++++++##
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicator_rev))
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw", p = 0.1)

## Heatmaps for SI
dm.melt = distancemodels %>% reshape2::melt()
names(dm.melt) = c("X", "Y", "Z")
n = length(unique(dm.melt$Z))
pal <- wes_palette("Zissou1", n, type = "continuous")

p1.wq = ggplot(dm.melt) + 
  geom_tile(aes(as.character(X), as.character(Y), fill= Z)) +
  scale_fill_distiller("",palette = "Blues", limits = c(0,1)) +ylab("")+xlab("")+
  ggtitle("")+
  theme_minimal(base_size = 12)+theme(axis.text = element_blank(),
                                      legend.position = "none")
##++++++++++++++++++++++++++++++ DENDROGRAMS SETUP +++++++++++++++++++++++++++##
## Substring for plotting
rownames(distancemodels) = toupper(uniquemodels)
colnames(distancemodels) = toupper(uniquemodels)

## Clustering
d = as.dist(distancemodels)
hc =  hclust(d, "complete")

distancemodels = as.data.frame(distancemodels)

n_clusters(distancemodels,
           package = c("easystats", "NbClust", "mclust"),
           standardize = FALSE)

## Optimal Number of clusters (Silhouette)
cl.wq.sil = fviz_nbclust(distancemodels, kmeans,
                         nstart = 25,k.max = 15,
                         method = "silhouette") +
  labs(subtitle = "Water Quality Clusters (Silhouette)")+theme(axis.text = element_text(size = 28),
                                                               plot.title = element_text(size = 32),
                                                               axis.title = element_text(size = 28),
                                                               plot.subtitle = element_text(size = 28))

cl.wq.wss = fviz_nbclust(distancemodels, kmeans,
                         nstart = 25,k.max = 15,
                         method = "wss") +
  labs(subtitle = "Water Quality Clusters (Elbow)")+theme(axis.text = element_text(size = 28),
                                                          plot.title = element_text(size = 32),
                                                          axis.title = element_text(size = 28),
                                                          plot.subtitle = element_text(size = 28))

## Establish your reference set for clustering
ref.wq = fviz_dend_ref(hc, k = 14+1,  
                       type = c("rectangle"),# Cut in four groups
                       cex = 2,  horiz = T, 
                       color_labels_by_k = F, 
                       rect = T, lower_rect = 0, 
                       main= "", 
                       palette = "jco",
                       rect_border = "jco",
                       rect_fill = T, lwd = 1)

ref.wq =   ref.wq + theme(axis.text.x = element_text(size = 32), 
                          axis.title.x = element_text(size = 32),
                          plot.title = element_text(size = 32))+
  ylab("Jaro-Winkler Distance")

## Save the plot
ggsave(plot = ref.wq,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/Reference/WQ.jpg",
       width=25, height=25, dpi=300)

## function to get results
lv <- function() .Last.value

## Dendrogram labels 
fviz_dend_labels(hc, k = 15+1,  
                 type = c("rectangle"),# Cut in four groups
                 cex = 2,  horiz = T, 
                 color_labels_by_k = F, show_labels = F,
                 rect = T, lower_rect = 0, 
                 main= "", 
                 palette = c( "#a6bddb","#74a9cf", "#3690c0","dodgerblue3",
                              "#0570b0","#045a8d", "royalblue3", "darkblue", 
                              "navyblue", 
                              "midnightblue","#023858"),
                 rect_border = c("#a6bddb","#74a9cf", "#3690c0","dodgerblue3",
                                 "#0570b0","#045a8d", "royalblue3", "darkblue", 
                                 "navyblue", 
                                 "midnightblue","#023858"),
                 rect_fill = T, lwd = 1)

## Now build out the text analysis 
result = lv()
names(result) = c("text")
result$count = rownames(result)
result$count = as.numeric(as.character(result$count))

result$cluster = ifelse(result$count==c(1:2), "1",
                        ifelse(result$count >=2 & result$count <=4, "2",
                               ifelse(result$count >=4 & result$count <=6, "3",
                                      ifelse(result$count >=7 & result$count <=12, "4",
                                             ifelse(result$count >=13 & result$count <=17, "5",
                                                    ifelse(result$count >=18 & result$count <=24, "6",
                                                           ifelse(result$count >=25 & result$count <=29, "7",
                                                                  ifelse(result$count >=30 & result$count <=31, "8",
                                                                         ifelse(result$count ==c(32), "9",
                                                                                ifelse(result$count >=33 & result$count <=34, "10",
                                                                                       ifelse(result$count >=35 & result$count <=36, "11",
                                                                                              ifelse(result$count >=37 & result$count <=43, "12",
                                                                                                     ifelse(result$count ==c(44), "13", "14")))))))))))))

##+++++++++++++++++++++++++++++++ WORD COUNT SUMMARY +++++++++++++++++++++++++##
## group to see individual indicators
result$text = as.character(as.factor(result$text))
results.ls = split(result, f= result$cluster)
results.ls = purrr::map(results.ls, ~ (.x %>% select(-count)))
results.ls = purrr::map(results.ls, ~ (.x %>% select(-cluster)))
results.ls = lapply(results.ls, paste, collapse = " ")
list_chars_as_tibble <- lapply(results.ls, function(x) tibble(txt = x))
results.ls = lapply(list_chars_as_tibble, unnest_tokens, word, txt)
map.dat = Map(cbind, results.ls, ID = names(results.ls))
results.df = do.call(rbind.data.frame, map.dat)

text_wordcounts = results.df %>% group_by(ID) %>%
  dplyr::count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >0,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("c"),]


## Extract the max number for each cluster
data.wordcount.sum = data.wordcount %>% group_by(ID) %>%
  dplyr::mutate(Max = max(n)) %>%
  dplyr::filter(n == Max) 

labels = aggregate(word ~ ID, unique(data.wordcount.sum), paste, collapse = " ")
write.csv(labels, "D:/Projects/Project_Indicators/Documents/Figures/Dendograms/Label_B.csv")

## Customize the plot and labels
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicator_rev))
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw", p = 0.1)
x = rep(1, 47)
distancemodels = rbind(distancemodels,x)
distancemodels = cbind(distancemodels,x)

## Clustering
d = as.dist(distancemodels)
hc =  hclust(d, "complete")

## Customize the labels
p.wq = fviz_dend(hc, k = 14+1,  
                 type = c("rectangle"),# Cut in four groups
                 cex = 2,  horiz = T, 
                 color_labels_by_k = F,
                 rect = T, lower_rect = 0, show_labels = F,
                 main= "", 
                 palette = "jco",
                 rect_border = "jco",
                 rect_fill = T, lwd = .75)

p.wq =   p.wq + theme(axis.text.x = element_text(size = 32), 
                      axis.title.x = element_text(size = 32),
                      plot.title = element_text(size = 32))+
  ylab("")

###############################################################################
## ++++++++++++++++++++++ Water Infr & Distrib  +++++++++++++++++++++++++++###
###############################################################################
data.frame.sub = df.indicators %>% dplyr::filter(Sub.Domain == "C")

# Convert to tidy format
tidy_text <- data.frame.sub %>%
  select(Citation, Indicator, Indicator_rev) %>%
  # Tokenize the word from the tweets
  unnest_tokens(input = Indicator_rev, output = word) %>%
  # Remove stop words
  anti_join(stop_words, by="word") %>% ungroup() %>%
  reshape2::melt(id = c("Citation", "Indicator")) 

## remove duplicates
tidy_text = tidy_text %>% group_by(Citation, Indicator) %>%
  distinct(value)

## Regroup
tidy_text_rev = tidy_text %>% group_by(Citation, Indicator)%>%
  dplyr::summarise(Indicator_rev = paste(value, collapse = " "))

## Back to Upper
# tidy_text_rev$Indicator_rev = toupper(tidy_text_rev$Indicator_rev)

data.frame.sub.clusters = map_dfr(tidy_text_rev$Indicator_rev, ~ {
  i <- which(stringdist(., tidy_text_rev$Indicator_rev, "jw") < 0.50)
  tibble(index = i, Indicator = tidy_text_rev$Indicator[i],Indicator_rev = tidy_text_rev$Indicator_rev[i])
}, .id = "group") %>%
  distinct(index, .keep_all = T) %>% 
  mutate(group = as.integer(group))

##+++++++++++++++++++++++++++++++ WORD COUNT SUMMARY +++++++++++++++++++++++++##
## group to see individual indicators
cleaned_text= as.character(as.factor(data.frame.sub.clusters$Indicator_rev))
cleaned_text <- paste(cleaned_text, collapse = " ")
text_df <- data_frame(Text = cleaned_text) 
text_words <- text_df %>% 
  unnest_tokens(output = word, input = Text) 
text_wordcounts <- text_words  %>% dplyr::count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >1,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("s"),]

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  mutate(rank = nrow(data.wordcount) - row_number()+1)

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  dplyr::mutate(percent = (n/sum(n))*100)

data.wordcount$code_rev = ifelse(data.wordcount$percent < 7, "general", data.wordcount$word)

data.wordcount.sum = data.wordcount %>% group_by(code_rev) %>%
  dplyr::summarize(percent.mod = sum(percent),
                   indicator.num = (percent.mod/100) * nrow(data.frame.sub), digits = 0)

write.csv(data.wordcount.sum, "D:/Projects/Project_Indicators/Data/Spreadsheets/ClusterResults/Indicators_C.csv")

##++++++++++++++++++++++++++++++ CLUSTERING ANALYSIS ++++++++++++++++++++++++##
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicator_rev))
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw", p = 0.1)


## Heatmaps for SI
dm.melt = distancemodels %>% reshape2::melt()
names(dm.melt) = c("X", "Y", "Z")
n = length(unique(dm.melt$Z))
pal <- wes_palette("Zissou1", n, type = "continuous")

p1.wid = ggplot(dm.melt) + 
  geom_tile(aes(as.character(X), as.character(Y), fill= Z)) +
  scale_fill_distiller("",palette = "Blues", limits = c(0,1)) +ylab("")+xlab("")+
  ggtitle("")+
  theme_minimal(base_size = 12)+theme(axis.text = element_blank(),
                                      legend.position = "none")
##++++++++++++++++++++++++++++++ DENDROGRAMS SETUP +++++++++++++++++++++++++++##
## Substring for plotting
rownames(distancemodels) = toupper(uniquemodels)
colnames(distancemodels) = toupper(uniquemodels)

## Clustering
d = as.dist(distancemodels)
hc =  hclust(d, "complete")

distancemodels = as.data.frame(distancemodels)

n_clusters(distancemodels,
           package = c("easystats", "NbClust", "mclust"),
           standardize = FALSE)

## Optimal Number of clusters (Silhouette)
cl.wid.sil = fviz_nbclust(distancemodels, kmeans,
                          nstart = 25,k.max = 15,
                          method = "silhouette") +
  labs(subtitle = "Water I&D Clusters (Silhouette)")+theme(axis.text = element_text(size = 28),
                                                           plot.title = element_text(size = 32),
                                                           axis.title = element_text(size = 28),
                                                           plot.subtitle = element_text(size = 28))

cl.wid.wss = fviz_nbclust(distancemodels, kmeans,
                          nstart = 25,k.max = 15,
                          method = "wss") +
  labs(subtitle = "Water I&D Clusters (Elbow)")+theme(axis.text = element_text(size = 28),
                                                      plot.title = element_text(size = 32),
                                                      axis.title = element_text(size = 28),
                                                      plot.subtitle = element_text(size = 28))

## Establish your reference set for clustering
ref.wid = fviz_dend_ref(hc, k = 12+1,  
                        type = c("rectangle"),# Cut in four groups
                        cex = 2,  horiz = T, 
                        color_labels_by_k = F, 
                        rect = T, lower_rect = 0, 
                        main= "", 
                        palette = c("dodgerblue4",  "mediumpurple4","thistle4", "palevioletred",
                                    "coral3","orangered2",
                                    "darkgoldenrod3", "lightsalmon1", "olivedrab3",
                                    "forestgreen","lightseagreen","slategray2", "slategray",
                                    "grey"),
                        rect_border = c("dodgerblue4",  "mediumpurple4","thistle4", "palevioletred",
                                        "coral3","orangered2",
                                        "darkgoldenrod3", "lightsalmon1", "olivedrab3",
                                        "forestgreen","lightseagreen","slategray2", "slategray",
                                        "grey"),
                        rect_fill = T, lwd = 1)

ref.wid =   ref.wid + theme(axis.text.x = element_text(size = 32), 
                            axis.title.x = element_text(size = 32),
                            plot.title = element_text(size = 32))+
  ylab("Jaro-Winkler Distance")

## Save the plot
ggsave(plot = ref.wid,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/Reference/WID.jpg",
       width=25, height=25, dpi=300)

## function to get results
lv <- function() .Last.value

## Dendrogram labels 
fviz_dend_labels(hc, k = 2+1,  
                 type = c("rectangle"),# Cut in four groups
                 cex = 2,  horiz = T, 
                 color_labels_by_k = F, show_labels = F,
                 rect = T, lower_rect = 0, 
                 main= "", 
                 palette = c( "#a6bddb","#74a9cf", "#3690c0","dodgerblue3",
                              "#0570b0","#045a8d", "royalblue3", "darkblue", 
                              "navyblue", 
                              "midnightblue","#023858"),
                 rect_border = c("#a6bddb","#74a9cf", "#3690c0","dodgerblue3",
                                 "#0570b0","#045a8d", "royalblue3", "darkblue", 
                                 "navyblue", 
                                 "midnightblue","#023858"),
                 rect_fill = T, lwd = 1)

## Now build out the text analysis 
result = lv()
names(result) = c("text")
result$count = rownames(result)
result$count = as.numeric(as.character(result$count))

result$cluster = ifelse(result$count==c(1:4), "1",
                        ifelse(result$count >=5 & result$count <=7, "2",
                               ifelse(result$count >=8 & result$count <= 10, "3",
                                      ifelse(result$count >=11 & result$count <= 13, "4",
                                             ifelse(result$count >=14 & result$count <= 15, "5",
                                                    ifelse(result$count ==c(16), "6","7"))))))


##+++++++++++++++++++++++++++++++ WORD COUNT SUMMARY +++++++++++++++++++++++++##
## group to see individual indicators
result$text = as.character(as.factor(result$text))
results.ls = split(result, f= result$cluster)
results.ls = purrr::map(results.ls, ~ (.x %>% select(-count)))
results.ls = purrr::map(results.ls, ~ (.x %>% select(-cluster)))
results.ls = lapply(results.ls, paste, collapse = " ")
list_chars_as_tibble <- lapply(results.ls, function(x) tibble(txt = x))
results.ls = lapply(list_chars_as_tibble, unnest_tokens, word, txt)
map.dat = Map(cbind, results.ls, ID = names(results.ls))
results.df = do.call(rbind.data.frame, map.dat)

text_wordcounts = results.df %>% group_by(ID) %>%
  dplyr::count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >0,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("c"),]

## Extract the max number for each cluster
data.wordcount.sum = data.wordcount %>% group_by(ID) %>%
  dplyr::mutate(Max = max(n)) %>%
  dplyr::filter(n == Max) 

labels = aggregate(word ~ ID, unique(data.wordcount.sum), paste, collapse = " ")
write.csv(labels, "D:/Projects/Project_Indicators/Documents/Figures/Dendograms/Label_C.csv")

## Customize the plot and labels
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicator_rev))
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw", p = 0.1)
x=rep(1,20)
distancemodels = rbind(distancemodels,x)
distancemodels = cbind(distancemodels,x)

## Clustering
d = as.dist(distancemodels)
hc =  hclust(d, "complete")

p.wid = fviz_dend(hc, k = 7+1,  
                  type = c("rectangle"),# Cut in four groups
                  cex = 2,  horiz = T, 
                  color_labels_by_k = F,
                  rect = T, lower_rect = 0, show_labels = F,
                  main= "", 
                  palette = "jco",
                  rect_border = "jco",
                  rect_fill = T, lwd = 1)                 


## Customize the labels
p.wid =   p.wid + theme(axis.text.x = element_text(size = 32), 
                        axis.title.x = element_text(size = 32),
                        plot.title = element_text(size = 32))+
  ylab("Jaro-Winkler Distance")

# ## Save the plot
# ggsave(plot = p.wid,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/Water_ID_1.jpg", 
#        width=21, height=25, dpi=300)

###############################################################################
## ++++++++++++++++++++++ Physical Environment  +++++++++++++++++++++++++++###
###############################################################################
data.frame.sub = df.indicators %>% dplyr::filter(Sub.Domain == "D")

# Convert to tidy format
tidy_text <- data.frame.sub %>%
  select(Citation, Indicator, Indicator_rev) %>%
  # Tokenize the word from the tweets
  unnest_tokens(input = Indicator_rev, output = word) %>%
  # Remove stop words
  anti_join(stop_words, by="word") %>% ungroup() %>%
  reshape2::melt(id = c("Citation", "Indicator")) 

## remove duplicates
tidy_text = tidy_text %>% group_by(Citation, Indicator) %>%
  distinct(value)

## Regroup
tidy_text_rev = tidy_text %>% group_by(Citation, Indicator)%>%
  dplyr::summarise(Indicator_rev = paste(value, collapse = " "))

## Back to Upper
# tidy_text_rev$Indicator_rev = toupper(tidy_text_rev$Indicator_rev)

data.frame.sub.clusters = map_dfr(tidy_text_rev$Indicator_rev, ~ {
  i <- which(stringdist(., tidy_text_rev$Indicator_rev, "jw") < 0.50)
  tibble(index = i, Indicator = tidy_text_rev$Indicator[i],Indicator_rev = tidy_text_rev$Indicator_rev[i])
}, .id = "group") %>%
  distinct(index, .keep_all = T) %>% 
  mutate(group = as.integer(group))

##+++++++++++++++++++++++++++++++ WORD COUNT SUMMARY +++++++++++++++++++++++++##
## group to see individual indicators
cleaned_text= as.character(as.factor(data.frame.sub.clusters$Indicator_rev))
cleaned_text <- paste(cleaned_text, collapse = " ")
text_df <- data_frame(Text = cleaned_text) 
text_words <- text_df %>% 
  unnest_tokens(output = word, input = Text) 
text_wordcounts <- text_words  %>% dplyr::count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >1,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("s"),]

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  dplyr::mutate(rank = nrow(data.wordcount) - row_number()+1)

data.wordcount = data.wordcount[order(data.wordcount$n, decreasing = TRUE), ] %>%
  dplyr::mutate(percent = (n/sum(n))*100)

data.wordcount$code_rev = ifelse(data.wordcount$percent < 7, "general", data.wordcount$word)

data.wordcount.sum = data.wordcount %>% group_by(code_rev) %>%
  dplyr::summarize(percent.mod = sum(percent),
                   indicator.num = (percent.mod/100) * nrow(data.frame.sub), digits = 0)

write.csv(data.wordcount.sum, "D:/Projects/Project_Indicators/Data/Spreadsheets/ClusterResults/Indicators_D.csv")

##++++++++++++++++++++++++++++++ CLUSTERING ANALYSIS ++++++++++++++++++++++++##
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicator_rev))
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw", p = 0.1)

## Heatmaps for SI
dm.melt = distancemodels %>% reshape2::melt()
names(dm.melt) = c("X", "Y", "Z")
n = length(unique(dm.melt$Z))
pal <- wes_palette("Zissou1", n, type = "continuous")

p1.pe = ggplot(dm.melt) + 
  geom_tile(aes(as.character(X), as.character(Y), fill= Z)) +
  scale_fill_distiller("",palette = "Blues", limits = c(0,1)) +ylab("")+xlab("")+
  ggtitle("")+
  theme_minimal(base_size = 12)+theme(axis.text = element_blank(),
                                      legend.position = "none")
##++++++++++++++++++++++++++++++ DENDROGRAMS SETUP +++++++++++++++++++++++++++##
## Substring for plotting
rownames(distancemodels) = toupper(uniquemodels)
colnames(distancemodels) = toupper(uniquemodels)

## Clustering
d = as.dist(distancemodels)
hc =  hclust(d, "complete")

distancemodels = as.data.frame(distancemodels)

n_clusters(distancemodels,
           package = c("easystats", "NbClust", "mclust"),
           standardize = FALSE)

## Optimal Number of clusters (Silhouette)
cl.pe.sil = fviz_nbclust(distancemodels, kmeans,
                         nstart = 25,k.max = 15,
                         method = "silhouette") +
  labs(subtitle = "Physical Environment Clusters (Silhouette)")+theme(axis.text = element_text(size = 28),
                                                                      plot.title = element_text(size = 32),
                                                                      axis.title = element_text(size = 28),
                                                                      plot.subtitle = element_text(size = 28))

cl.pe.wss = fviz_nbclust(distancemodels, kmeans,
                         nstart = 25,k.max = 15,
                         method = "wss") +
  labs(subtitle = "Physical Environment Clusters (Elbow)")+theme(axis.text = element_text(size = 28),
                                                                 plot.title = element_text(size = 32),
                                                                 axis.title = element_text(size = 28),
                                                                 plot.subtitle = element_text(size = 28))

## Establish your reference set for clustering
ref.pe = fviz_dend_ref(hc, k = 12,  
                       type = c("rectangle"),# Cut in four groups
                       cex = 2,  horiz = T, 
                       color_labels_by_k = F, 
                       rect = T, lower_rect = 0, 
                       main= "", 
                       palette = c("dodgerblue4",  "mediumpurple4","thistle4", "palevioletred",
                                   "coral3","orangered2",
                                   "darkgoldenrod3", "lightsalmon1", "olivedrab3",
                                   "forestgreen","lightseagreen","slategray2"),
                       # rect_border = c("dodgerblue4",  "mediumpurple4","thistle4", "palevioletred",
                       #                 "coral3","orangered2",
                       #                 "darkgoldenrod3", "lightsalmon1", "olivedrab3",
                       #                 "forestgreen","lightseagreen","slategray2"),
                       rect_fill = T, lwd = 1)

ref.pe =   ref.pe + theme(axis.text.x = element_text(size = 32), 
                          axis.title.x = element_text(size = 32),
                          plot.title = element_text(size = 32))+
  ylab("Jaro-Winkler Distance")

## Save the plot
ggsave(plot = ref.pe,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/Reference/PE.jpg",
       width=25, height=25, dpi=300)

## function to get results
lv <- function() .Last.value

## Dendrogram labels 
fviz_dend_labels(hc, k = 2,  
                 type = c("rectangle"),# Cut in four groups
                 cex = 2,  horiz = T, 
                 color_labels_by_k = F, show_labels = F,
                 rect = T, lower_rect = 0, 
                 main= "", 
                 palette = c( "#a6bddb","#74a9cf", "#3690c0","dodgerblue3",
                              "#0570b0","#045a8d", "royalblue3", "darkblue", 
                              "navyblue", 
                              "midnightblue","#023858"),
                 rect_border = c("#a6bddb","#74a9cf", "#3690c0","dodgerblue3",
                                 "#0570b0","#045a8d", "royalblue3", "darkblue", 
                                 "navyblue", 
                                 "midnightblue","#023858"),
                 rect_fill = T, lwd = 1)

## Now build out the text analysis 
result = lv()
names(result) = c("text")
result$count = rownames(result)
result$count = as.numeric(as.character(result$count))

result$cluster = ifelse(result$count==c(1:2), "1",
                        ifelse(result$count >=3 & result$count <=6, "2",
                               ifelse(result$count >=7 & result$count <= 9, "3",
                                      ifelse(result$count >=10 & result$count <= 13, "4",
                                             ifelse(result$count ==c(14), "5",
                                                    ifelse(result$count >=15 & result$count <= 16, "6",
                                                           ifelse(result$count ==c(17), "7",
                                                                  ifelse(result$count ==c(18), "8",
                                                                         ifelse(result$count >=19 & result$count <= 20, "9",
                                                                                ifelse(result$count ==c(21), "10",
                                                                                       ifelse(result$count >=22 & result$count <= 23, 
                                                                                              "11", "12")))))))))))


##+++++++++++++++++++++++++++++++ WORD COUNT SUMMARY +++++++++++++++++++++++++##
## group to see individual indicators
result$text = as.character(as.factor(result$text))
results.ls = split(result, f= result$cluster)
results.ls = purrr::map(results.ls, ~ (.x %>% select(-count)))
results.ls = purrr::map(results.ls, ~ (.x %>% select(-cluster)))
results.ls = lapply(results.ls, paste, collapse = " ")
list_chars_as_tibble <- lapply(results.ls, function(x) tibble(txt = x))
results.ls = lapply(list_chars_as_tibble, unnest_tokens, word, txt)
map.dat = Map(cbind, results.ls, ID = names(results.ls))
results.df = do.call(rbind.data.frame, map.dat)

text_wordcounts = results.df %>% group_by(ID) %>%
  dplyr::count(word, sort = TRUE) 

## Sub to select the counts greater than 2
data.wordcount = text_wordcounts[text_wordcounts$n >0,]
data.wordcount = data.wordcount[data.wordcount$word != c("water"),]
data.wordcount = data.wordcount[data.wordcount$word != c("c"),]

## Extract the max number for each cluster
data.wordcount.sum = data.wordcount %>% group_by(ID) %>%
  dplyr::mutate(Max = max(n)) %>%
  dplyr::filter(n == Max) 

labels = aggregate(word ~ ID, unique(data.wordcount.sum), paste, collapse = " ")
write.csv(labels, "D:/Projects/Project_Indicators/Documents/Figures/Dendograms/Label_D.csv")

## Customize the plot and labels
uniquemodels <- unique(as.character(data.frame.sub.clusters$Indicator_rev))
distancemodels <- stringdistmatrix(uniquemodels,uniquemodels,method = "jw", p = 0.1)
# x=rep(1,27)
# distancemodels = rbind(distancemodels,x)
# distancemodels = cbind(distancemodels,x)
## Clustering
d = as.dist(distancemodels)
hc =  hclust(d, "complete")

## Dendrogram
p.pe= fviz_dend(hc, k = 12,  
                type = c("rectangle"),# Cut in four groups
                cex = 2,  horiz = T, 
                color_labels_by_k = F, 
                rect = T, lower_rect = 0, show_labels = F,
                main= "", 
                palette = "jco",
                rect_border = "jco",
                rect_fill = T, lwd = 1)

## Customize the labels
p.pe =  p.pe + theme(axis.text.x = element_text(size = 32), 
                     axis.title.x = element_text(size = 32),
                     plot.title = element_text(size = 32))+
  ylab("Jaro-Winkler Distance")

# ## Save the plot
# ggsave(plot = p.pe,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/Water_PE_1.jpg", 
#        width=21, height=25, dpi=300)

###############################################################################
## ++++++++++++++++++++++ Combined plots of hm &dg  ++++++++++++++++++++++++###
###############################################################################   
## Combined plot
plot =      
  cowplot::ggdraw() +
  cowplot::draw_plot(p.ws,x=0,  y = 0.45, width =0.45, height= 0.55) + 
  cowplot::draw_plot(p.wq,x=0.48, y=0.45, width =0.45, height= 0.55) + 
  cowplot::draw_plot(p.wid,x=0, y=0, width =0.45, height= 0.47)+
  cowplot::draw_plot(p.pe,x=0.48,  y = 0, width =0.45, height= 0.47)+
  cowplot::draw_label("Water Source", size = 28, 
                      fontfamily = "Helvetica", x= 0.22, y = 0.95+0.02)+
  cowplot::draw_label("Water Quality", size = 28, 
                      fontfamily = "Helvetica", x= 0.75, y = 0.95+0.02)+
  cowplot::draw_label("Water Infrastructure & Distribution", size = 28, 
                      fontfamily = "Helvetica", x= 0.25, y = 0.45+0.05-0.05)+
  cowplot::draw_label("Physical Environment", size = 28, 
                      fontfamily = "Helvetica", x= 0.75, y = 0.45+0.05-0.05)+
  cowplot::draw_label("A", size = 28, fontface= "bold",
                      fontfamily = "Helvetica", x= 0.05, y = 0.95+0.02)+
  cowplot::draw_label("B", size = 28, fontface= "bold",
                      fontfamily = "Helvetica", x= 0.55, y = 0.95+0.02)+
  cowplot::draw_label("C", size = 28, fontface= "bold",
                      fontfamily = "Helvetica", x= 0.05, y = 0.45+0.05-0.05)+
  cowplot::draw_label("D", size = 28, fontface= "bold",
                      fontfamily = "Helvetica", x= 0.55, y = 0.45+0.05-0.05)

ggsave(plot = plot,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/FIWS_dend.jpg", 
       width=21, height=17, dpi=300)

## Elbow & Silhouette plots

plot.el = ggarrange(cl.ws.wss, cl.wq.wss, cl.wid.wss, cl.pe.wss, nrow=2, ncol =2)
ggsave(plot = plot.el,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/FIWS_el.jpg", 
       width=21, height=17, dpi=300)

plot.sl = ggarrange(cl.ws.sil, cl.wq.sil, cl.wid.sil, cl.pe.sil, nrow=2, ncol =2)
ggsave(plot = plot.sl,"D:/Projects/Project_Indicators/Documents/Figures/Dendograms/FIWS_sil.jpg", 
       width=21, height=17, dpi=300)

## Get a legend
p1.pe.legend.ws = ggplot(dm.melt) + 
  geom_tile(aes(as.character(X), as.character(Y), fill= Z)) +
  scale_fill_distiller("",palette = "Blues", limits = c(0,1)) +
  ylab("")+xlab("")+
  ggtitle("")+
  theme_minimal(base_size = 28)+theme(axis.text.x = element_text(angle = 90))+
  theme(legend.key.height = unit(2.82, "cm"),
        legend.key.width = unit(1, "cm"))+
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5))

legend.1.ws = get_legend(p1.pe.legend.ws+theme(legend.position = "left", 
                                               legend.title.align = 0.5))
## make the heatmap
plot.hm.fiws =      
  cowplot::ggdraw() +
  cowplot::draw_plot(p1.ws,x=0,  y = 0.5+0.02, width =0.45, height= 0.45) + 
  cowplot::draw_plot(p1.wq,x=0.5, y=0.5+0.02, width =0.45, height= 0.45) + 
  cowplot::draw_plot(p1.wid,x=0, y=0+0.1, width =0.45, height= 0.4)+
  cowplot::draw_plot(p1.pe,x=0.5,  y = 0+0.1, width =0.45, height= 0.4)+
  cowplot::draw_plot(legend.1.ws,x = 0.25, y= 0-0.15, width = 0.45, height = 0.45)+
  cowplot::draw_label("Water Source", size = 28, 
                      fontfamily = "Helvetica", x= 0.22, y = 0.95+0.02)+
  cowplot::draw_label("Water Quality", size = 28, 
                      fontfamily = "Helvetica", x= 0.75, y = 0.95+0.02)+
  cowplot::draw_label("Water Infrastructure & Distribution", size = 28, 
                      fontfamily = "Helvetica", x= 0.25, y = 0.45+0.05)+
  cowplot::draw_label("Physical Environment", size = 28, 
                      fontfamily = "Helvetica", x= 0.75, y = 0.45+0.05)+
  cowplot::draw_label("A", size = 28, 
                      fontfamily = "Helvetica", x= 0.05, y = 0.95+0.02)+
  cowplot::draw_label("B", size = 28, 
                      fontfamily = "Helvetica", x= 0.55, y = 0.95+0.02)+
  cowplot::draw_label("C", size = 28, 
                      fontfamily = "Helvetica", x= 0.05, y = 0.45+0.05)+
  cowplot::draw_label("D", size = 28, 
                      fontfamily = "Helvetica", x= 0.55, y = 0.45+0.05)

ggsave(plot = plot.hm,"D:/Projects/Project_Indicators/Documents/Figures/Heatmaps/FIWS.jpg", 
       width=21, height=25, dpi=300)

library(ggplot2)
library(tidyr)
library(viridis)
library(tidyverse)
library(reshape2)
library(cowplot)
library(ggpubr)
source("D:/Projects/Project_Mother/Scripts/kings.R")
source("D:/Projects/Project_Mother/Scripts/map.R")
palette <- distinctColorPalette(n)
setseed(1999)
n <- 60
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
## Now read in in your sampled data
dataframe = read.csv("D:/Projects/Project_Indicators/Data/Spreadsheets/Indicators/Indicators_processed_v3.csv")
lu_table = read.csv("D:/Projects/Project_Indicators/Data/Spreadsheets/Indicators/Rev_Categories.csv")

## Now join them together
df_indicators = left_join(dataframe, lu_table, by = c("Group.X" = "Number"))

df_indicators$Count = as.numeric(as.character(df_indicators$Count))
df_indicators$Group = tolower(df_indicators$Group)
df_indicators$Indicator_rev = tolower(df_indicators$Indicator_rev)

dataframe.sum = df_indicators %>% group_by(Dimension.y) %>%
  dplyr::summarise(number = sum(Count))

dataframe.sum = dataframe.sum %>% filter(number >1)
dataframe.sum = dataframe.sum[order(dataframe.sum$number),]

df_indicators$Indicatand_rev = as.character(as.factor(df_indicators$Indicatand_rev))

indicator_sum = df_indicators %>% group_by(Dimension.y, Citation) %>%
  dplyr::summarise(number = sum(Count)) %>% na.omit()

###################### ++++++++ CIRCULAR PLOTS ++++++++++ #####################
## Create a Color Scale
color.scale.plot <- indicator_sum %>%
  mutate(color =  plyr::revalue(Dimension.y,
                                   c(# Dimensions
                                     "Water Resources" = "lightsalmon1",
                                     # Water
                                     "Land and Water Use" = "peachpuff",
                                     #Infrastructure
                                     "Institutions and Management" = "thistle4",
                                     # Governance
                                     "Socio-Cultural" = "olivedrab3",
                                     #
                                     "Economic" = "lightseagreen")))

# Color scale
myColorScale <- unique(as.vector(color.scale.plot$color))
names(myColorScale) <- unique(as.vector(color.scale.plot$variable))
colScale <- scale_fill_manual(name = "Included Dimensions",values = myColorScale)

# Declare data as data.indices.sub and make numeric
data = indicator_sum
data$number = as.numeric(as.character(data$number))
data$Citation = as.character(data$Citation)

# Get the name and the y position of each label
data <- data %>% arrange(Citation)
nObsType = length(unique(data$variable))
data$id <- rep( seq(1, nrow(data)/nObsType) , each=nObsType)

# Get the name and the y position of each label
label_data <- data %>% group_by(id, Citation) %>% summarize(tot=sum(value))
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)

# Make the plot
data = na.omit(data)
legend.plot = ggplot(transform(data,
                 Name=factor(variable,levels=c("Specific Geography", "Temporal Extent",
                                               "Spatial Extent",
                                               "Snow", "Groundwater", "Groundwater-Surface\nWater Interaction",
                                               "Physical Infrastructure", "Water Transfer\nImport or Export",
                                               "Policy, Management,\nor Governance", 
                                               "Justice & Equity")))) + 
  geom_bar(aes(x= Citation, y=value, fill=Name), color = "black", stat = "identity", alpha=0.9) +
  colScale+
  geom_bar(aes(x=Citation, y=value, fill=Name), stat="identity", alpha=0.5) +
  ylim(-4,9) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    legend.direction = "horizontal",
    axis.title = element_blank(),
    axis.text = element_blank(),
    panel.grid = element_blank(),
    plot.margin = margin(0, 0, 0, 0, "cm")
  ) +
  coord_polar(start = 0) +
  geom_text(data=label_data, aes(x=Citation, y = tot +0.5, label=Citation, hjust=hjust), 
            color="black", fontface="bold",alpha=0.6, size=3.5, angle= label_data$angle, inherit.aes = FALSE,
            parse = FALSE)+
  guides(fill = guide_legend(title.position="top", title.hjust = 0.5))

legend = get_legend(legend.plot+theme(legend.position = "bottom", legend.title.align = 0.5))

main.plot = ggplot(transform(data,
                               Name=factor(variable,levels=c("Specific Geography", "Temporal Extent",
                                                             "Spatial Extent",
                                                             "Snow", "Groundwater", "Groundwater-Surface\nWater Interaction",
                                                             "Physical Infrastructure", "Water Transfer\nImport or Export",
                                                             "Policy, Management,\nor Governance", 
                                                             "Equity, Justice & Equity")))) + 
  geom_bar(aes(x= Citation, y=value, fill=Name), color = "black", stat = "identity", alpha=0.9) +
  colScale+
  geom_bar(aes(x=Citation, y=value, fill=Name), stat="identity", alpha=0.5) +
  ylim(-4,9) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    legend.direction = "horizontal",
    axis.title = element_blank(),
    axis.text = element_blank(),
    panel.grid = element_blank(),
    plot.margin = margin(0, 0, 0, 0, "cm")) +
  coord_polar(start = 0) +
  geom_text(data=label_data, aes(x=Citation, y = tot +0.5, label=Citation, hjust=hjust), 
            color="black", fontface="bold",alpha=0.6, size=4, angle= label_data$angle, inherit.aes = FALSE,
            parse = FALSE)
  # geom_text(data=label_data, aes(x=id, y=value+10, label=time, hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2.5, angle= label_data$angle, inherit.aes = FALSE ) +

indices.plot = cowplot::ggdraw() +
  cowplot::draw_plot(main.plot,x=0,  y = 0.05,scale = 0.94) + 
  cowplot::draw_plot(legend,x=0, y=-0.42, scale = .85)  

ggsave(plot = indices.plot, "D:/Projects/Project_Indicators/Documents/Figures/indices.png", width=10, height=10, dpi=300)

  